let S=Math.sin,C=Math.cos,Rn=Math.random;var cacheItem,overlay,SHMdata,audioConsent=!1;let scratchCanvas=document.createElement("canvas"),sctx=scratchCanvas.getContext("2d",{alpha:!0,antialias:!0,imageSmoothingEnabled:!0,desynchronized:!0,premultipliedAlpha:!1}),scratchImage=new Image,ModuleBase="https://srmcgann.github.io/Coordinates",cache={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},Renderer=async e=>{var a,r,t,o,i,n,c,s=0,l=0,$=0,p=1920,h=1080,f=0,u=0,m=0,_=2e3,d=!0,g=10,v=!1,y=.2,x=!1,b=0,E="default",T=!1,P=0,w="",I=!0,A={mode:"webgl2",options:{alpha:!0,antialias:!0,desynchronized:!0,premultipliedAlpha:!1}},F=[],L=[],M=[],B=[],U=[];void 0!==e&&Object.keys(e).forEach((a,r)=>{switch(a.toLowerCase()){case"plugins":e[a].map(e=>{if("post processing"===e.type.toLowerCase()&&(void 0===e.enabled||e.enabled)){var a={name:e.type.toLowerCase(),value:e.value.toLowerCase(),enabled:void 0===e.enabled||!!e.enabled,params:e?.params?e.params.map(e=>e.toLowerCase()):[]};U.push(a)}});break;case"width":p=e[a];break;case"height":h=e[a];break;case"alpha":x=e[a];break;case"x":s=e[a];break;case"y":l=e[a];break;case"z":$=e[a];break;case"roll":f=e[a];break;case"pitch":u=e[a];break;case"yaw":m=e[a];break;case"fov":_=e[a];break;case"clearcolor":b=e[a];break;case"attachtobody":d=!!e[a];break;case"exportgpuspecs":v=!!e[a];break;case"margin":g=e[a];break;case"cameramode":E=e[a];break;case"ambientlight":y=e[a];break;case"showcrosshair":T=!!e[a];break;case"crosshairsel":P=e[a];break;case"crosshairmap":w=e[a];break;case"context":A.mode=e[a].mode,A.options=e[a].options}});let k=document.createElement("canvas"),N=k.getContext(A.mode,A.options);k.width=p,k.height=h;let z=A.mode;"2d"!=A.mode&&console.log(`GLSL version: ${N.getParameter(N.SHADING_LANGUAGE_VERSION)}`),v&&getParams(N),"2d"===A.mode||N.viewport(0,0,k.width,k.height),d&&(k.style.display="block",k.style.position="absolute",k.style.left="50vw",k.style.top="50vh",k.style.transform="translate(-50%, -50%)",k.style.background="#000",document.body.appendChild(k)),window.addEventListener("resize",n=e=>{var a,r=c.margin,t=document.body,o=0!==k.width?k.height/k.width:1;t.clientHeight/t.clientWidth>o?(k.style.width=`${(a=t.clientWidth)-2*r}px`,k.style.height=`${a*o-2*r}px`):(k.style.height=`${(a=t.clientHeight)-2*r}px`,k.style.width=`${a/o-2*r}px`)}),c={c:k,ctx:N,contextType:z,t:0,alpha:x,width:p,height:h,x:s,y:l,z:$,roll:f,pitch:u,yaw:m,fov:_,ready:!1,ambientLight:y,pointLights:M,pointLightCols:B,particleQueue:L,alphaQueue:F,active:I,cameraMode:E,showCrosshair:T,crosshairSel:P,crosshairMap:w,pageX:a,pageY:r,mouseX:t,mouseY:o,mouseButton:i,rsz:n,margin:g,optionalPlugins:U},n(),c["2d"==z?"ctx":"gl"]=N;var O=c;let V=()=>{"2d"===z?k.width=O.c.width:(N.clearColor(0,0,0,1),N.clear(N.COLOR_BUFFER_BIT),N.clear(N.DEPTH_BUFFER_BIT))};O.Clear=V;let D=async(e,a=!1,r=!1)=>{var t,o,i,n=e.shader.datasets[e.datasetIdx],c=n.program;if(O.optionalPlugins.map(e=>{"post processing"===e.name&&("equirectangular"===e.value?e.enabled&&(t=!0,O.equirectangularPlugin=!0,o=-1!=e.params.indexOf("omitsplitcheck")):(t=!1,O.equirectangularPlugin=!1))}),void 0!==e?.shader){if(!a&&(e.isSprite||e.isLight&&e.showSource))O.alphaQueue=[e,...O.alphaQueue];else if(!a&&e.isParticle)O.particleQueue=[e,...O.particleQueue];else{N.useProgram(c);for(var s=0;s<(t&&!o?2:1);s++){if(O.locPlugin=N.getUniformLocation(n.program,"plugin"),O.locOmitSplitCheck=N.getUniformLocation(n.program,"omitSplitCheck"),O.locSplitCheckPass=N.getUniformLocation(n.program,"splitCheckPass"),N.uniform1f(O.locPlugin,t?1:0),N.uniform1f(O.locOmitSplitCheck,o?1:0),N.uniform1f(O.locSplitCheckPass,s),e.showBounding)var l=ShowBounding(e,O,e.showBounding,t,o,s);if("particles"==e.shapeType)O.ctx.blendFunc(N.ONE,N.SRC_ALPHA),O.ctx.enable(N.BLEND),N.uniform1f(n.locPointSize,e.size*(r?3:1)),N.uniform1f(n.locIsParticle,e.isParticle),N.uniform1f(n.locPenumbraPass,e.penumbraPass?1:0),N.uniform1f(n.locT,O.t),N.uniform1f(n.locColorMix,e.colorMix),N.uniform1f(n.locIsSprite,e.isSprite),N.uniform1f(n.locIsLight,e.isLight),N.uniform1f(n.locCameraMode,"fps"==O.cameraMode.toLowerCase()?1:0),N.uniform1f(n.locAlpha,r?e.alpha*e.penumbra:e.alpha),N.uniform3f(n.locColor,...HexToRGB(e.color)),N.uniform1f(n.locAmbientLight,h/8),N.uniform2f(n.locResolution,O.width,O.height),N.uniform3f(n.locCamPos,O.x,O.y,O.z),N.uniform3f(n.locCamOri,O.roll,O.pitch,O.yaw),N.uniform3f(n.locGeoPos,e.x,e.y,e.z),N.uniform3f(n.locGeoOri,e.roll,e.pitch,e.yaw),N.uniform1f(n.locFov,O.fov),N.uniform1f(n.locEquirectangular,e.equirectangular?1:0),N.uniform1f(n.locRenderNormals,0),e?.vertices?.length&&(N.bindBuffer(N.ARRAY_BUFFER,e.vertex_buffer),N.bufferData(N.ARRAY_BUFFER,e.vertices,N.STATIC_DRAW),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,e.vIndices,N.STATIC_DRAW),N.bindBuffer(N.ARRAY_BUFFER,e.vertex_buffer),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),n.locPosition=N.getAttribLocation(n.program,"position"),N.vertexAttribPointer(n.locPosition,3,N.FLOAT,!1,0,0),N.enableVertexAttribArray(n.locPosition),N.drawElements(N.POINTS,e.vertices.length/3|0,N.UNSIGNED_INT,0),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,null),N.bindBuffer(N.ARRAY_BUFFER,null)),O.ctx.blendFunc(N.ONE,N.ZERO),O.ctx.disable(N.BLEND);else{switch(N.activeTexture(N.TEXTURE0),e.textureMode){case"video":BindImage(N,n.resource,n.texture,e.textureMode,O.t,e.map);break;case"canvas":N.activeTexture(N.TEXTURE2),BindImage(N,e.canvasTexture,n.texture,e.textureMode,O.t,e.map)}void 0!==e.canvasTexture&&(N.activeTexture(N.TEXTURE2),BindImage(N,e.canvasTexture,n.supplementalTexture,"canvas",O.t,e.map),N.uniform1i(n.locSupplementalTexture,2),N.uniform1f(n.locSupplementalTextureMix,e.canvasTextureMix)),N.activeTexture(N.TEXTURE0),N.uniform1i(n.locTexture,n.texture),N.bindTexture(N.TEXTURE_2D,n.texture),e.heightMap?(N.activeTexture(N.TEXTURE4),N.uniform1i(n.locHeightMap,4),BindImage(N,n.heightResource,n.heightTexture,e.heightMapIsCanvas?"canvas":e.heightTextureMode,O.t,e.heightMap),N.uniform1i(n.locHeightTexture,n.heightTexture),N.uniform1f(n.locUseHeightMap,1),N.uniform1f(n.locHeightMapIntensity,e.heightMapIntensity),N.uniform1f(n.locEquirectangularHeightmap,e.equirectangularHeightmap?1:0),N.bindTexture(N.TEXTURE_2D,n.heightTexture),N.activeTexture(N.TEXTURE0)):N.uniform1f(n.locUseHeightMap,0),N.uniform1i(n.locPointLightCount,O.pointLights.length);var $=new Float32Array,p=new Float32Array;O.pointLights.map(e=>{$=[...$,e.x,e.y,e.z,e.lum],HexToRGB(e.color),p=[...p,...HexToRGB(e.color),1]}),$.length&&(N.uniform4fv(n.locPointLights,$),N.uniform4fv(n.locPointLightCols,p));var h=O.ambientLight;if(n.optionalLighting.map(e=>{"ambientLight"===e.name&&(h=e.value)}),N.useProgram(c),n.optionalUniforms.map(a=>{if("object"==typeof a?.loc)switch(N[a.dataType](a.loc,a.value),N.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"reflection":N.activeTexture(N.TEXTURE1),"video"==a.textureMode&&BindImage(N,a.video,a.refTexture,a.textureMode,O.t,a.map),N.useProgram(c),N.activeTexture(N.TEXTURE1),N.uniform1i(a.locRefTexture,1),N.bindTexture(N.TEXTURE_2D,a.refTexture),N.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"phong":a.locPhongTheta=N.getUniformLocation(n.program,"phongTheta"),N.uniform1f(a.locPhongTheta,a.theta+Math.PI)}}),N.uniform1f(n.locT,O.t),N.uniform1f(n.locIsParticle,e.isParticle),N.uniform1f(n.locPenumbraPass,0),N.uniform1f(n.locColorMix,e.colorMix),N.uniform1f(n.locIsSprite,e.isSprite),N.uniform1f(n.locIsLight,e.isLight),N.uniform1f(n.locCameraMode,"fps"==O.cameraMode.toLowerCase()?1:0),N.uniform1f(n.locAlpha,e.alpha),N.uniform3f(n.locColor,...HexToRGB(e.color)),N.uniform1f(n.locAmbientLight,h/8),N.uniform2f(n.locResolution,O.width,O.height),N.uniform3f(n.locCamPos,O.x,O.y,O.z),N.uniform3f(n.locCamOri,O.roll,O.pitch,O.yaw),N.uniform3f(n.locGeoPos,e.x,e.y,e.z),N.uniform3f(n.locGeoOri,e.roll,e.pitch,e.yaw),N.uniform1f(n.locFov,O.fov),N.uniform1f(n.locEquirectangular,e.equirectangular?1:0),N.uniform1f(n.locRenderNormals,0),N.bindBuffer(N.ARRAY_BUFFER,e.uv_buffer),N.bufferData(N.ARRAY_BUFFER,e.uvs,N.STATIC_DRAW),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,e.uvIndices,N.STATIC_DRAW),N.vertexAttribPointer(n.locUv,2,N.FLOAT,!1,0,0),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,null),N.bindBuffer(N.ARRAY_BUFFER,null),e?.normalVecs.length&&(N.bindBuffer(N.ARRAY_BUFFER,e.normalVec_buffer),N.bufferData(N.ARRAY_BUFFER,e.normalVecs,N.STATIC_DRAW),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,e.nIndices,N.STATIC_DRAW),N.bindBuffer(N.ARRAY_BUFFER,e.normalVec_buffer),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),n.locNormalVec=N.getAttribLocation(n.program,"normalVec"),N.vertexAttribPointer(n.locNormalVec,3,N.FLOAT,!1,0,0),N.enableVertexAttribArray(n.locNormalVec),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,null),N.bindBuffer(N.ARRAY_BUFFER,null)),e?.vertices?.length){if(N.bindBuffer(N.ARRAY_BUFFER,e.vertex_buffer),t){for(var f=new Float32Array,u=0;u<e.vertices;u+=9)var m=e.vertices[u+0],_=e.vertices[u+1],d=e.vertices[u+2],g=e.vertices[u+3],v=e.vertices[u+4],y=e.vertices[u+5],x=e.vertices[u+6],b=e.vertices[u+7],E=e.vertices[u+8];N.bufferData(N.ARRAY_BUFFER,f,N.STATIC_DRAW)}else N.bufferData(N.ARRAY_BUFFER,e.vertices,N.STATIC_DRAW);N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,e.vIndices,N.STATIC_DRAW),N.bindBuffer(N.ARRAY_BUFFER,e.vertex_buffer),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),n.locPosition=N.getAttribLocation(n.program,"position"),N.vertexAttribPointer(n.locPosition,3,N.FLOAT,!1,0,0),N.enableVertexAttribArray(n.locPosition),N.drawElements(e.wireframe?N.LINE_STRIP:N.TRIANGLES,e.vertices.length/3|0,N.UNSIGNED_INT,0),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,null),N.bindBuffer(N.ARRAY_BUFFER,null)}N.uniform1f(n.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(N.bindBuffer(N.ARRAY_BUFFER,e.normal_buffer),N.bufferData(N.ARRAY_BUFFER,e.normals,N.STATIC_DRAW),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),N.bufferData(N.ELEMENT_ARRAY_BUFFER,e.nIndices,N.STATIC_DRAW),N.vertexAttribPointer(n.locNormal,3,N.FLOAT,!1,0,0),n.locNormal=N.getAttribLocation(n.program,"normal"),N.bindBuffer(N.ARRAY_BUFFER,e.normal_buffer),N.bufferData(N.ARRAY_BUFFER,e.normals,N.STATIC_DRAW),N.enableVertexAttribArray(n.locNormal),N.drawElements(N.LINES,e.normals.length/3|0,N.UNSIGNED_INT,0),N.bindBuffer(N.ELEMENT_ARRAY_BUFFER,null),N.bindBuffer(N.ARRAY_BUFFER,null))}}}}};return O.Draw=D,O.nullShader=await BasicShader(O,[{uniform:{type:"phong",value:0}}]),O.particleShader=await BasicShader(O,[]),window.addEventListener("mousemove",e=>{var a=O.c.getBoundingClientRect();O.mouseX=(e.pageX-a.left)/O.c.clientWidth*O.width,O.mouseY=(e.pageY-a.top)/O.c.clientHeight*O.height}),window.addEventListener("mousedown",e=>{O.mouseButton=e.buttons}),window.addEventListener("mouseup",e=>{O.mouseButton=-1}),O},ResizeRenderer=async(e,a,r)=>{e.width=a,e.height=r,e.c.width=a,e.c.height=r,e.rsz(),"2d"===e.ctx.mode||e.ctx.viewport(0,0,e.c.width,e.c.height)},DestroyRenderer=async e=>{e.c.remove(),e.active=!1},DestroyShape=e=>{"point light"===e.shapeType&&(e.renderer.pointLights=e.renderer.pointLights.filter((a,r)=>r!=e.pointLightID),e.renderer.pointLights.map((e,a)=>e.pointLightID=a))},LoadOBJ=async(e,a,r,t,o,i,n,c,s=!0,l=!0)=>{var $,p,h,f,u={vertices:[],normals:[],uvs:[]};if(l&&(cacheItem=cache.objFiles.filter(a=>a.url==e)).length)u=cacheItem[0].ret;else{var m=new Float32Array,_=new Float32Array,d=new Float32Array,g=new Float32Array;await fetch(e).then(e=>e.text()).then(e=>{e.split("\n").forEach(e=>{var a=e.split(" "),r=a[0];switch(r){case"v":a.shift(),m=[...m,a.map(e=>+e)];break;case"vt":a.shift(),d=[...d,a.map(e=>+e)];break;case"vn":a.shift(),_=[..._,a.map(e=>+e)];break;case"f":a.shift(),g=[...g,a.map(e=>e)]}}),g.map(e=>{var a,r,t,o=new Float32Array,i=new Float32Array,n=new Float32Array,c=!1,s=!1;e.map(e=>{var l=e.split("/");switch(l.length){case 1:o=[...o,m[(a=l[0])-1]];break;case 2:a=l[0],r=l[1],o=[...o,m[a-1]],i=[...i,d[r-1]],c=!0;break;case 3:a=l[0],r=l[1],t=l[2],o=[...o,m[a-1]],i=[...i,d[r-1]],n=[...n,_[t-1]],s=!0}});var l=o[0][0],p=o[0][1],h=o[0][2],f=o[1][0],g=o[1][1],v=o[1][2],y=o[2][0],x=o[2][1],b=o[2][2];if(s)var E=n[0][0],T=n[0][1],P=n[0][2],w=n[1][0],I=n[1][1],A=n[1][2],F=n[2][0],L=n[2][1],M=n[2][2];if(4==o.length){var B=o[3][0],U=o[3][1],k=o[3][2];if(s)var N=n[3][0],z=n[3][1],O=n[3][2]}switch(o.length){case 3:$=new Float32Array,n.map((e,a)=>{$=[...$,[l,p,h,l+E,p+T,h+P],[f,g,v,f+w,g+I,v+A],[y,x,b,y+F,x+L,b+M]]}),n=$,u.vertices=[...u.vertices,...o[0],...o[1],...o[2]],i.length&&void 0!==i[0]&&(u.uvs=[...u.uvs,...i[0],...i[1],...i[2]]),n.length&&void 0!==n[0]&&(u.normals=[...u.normals,...n[0],...n[1],...n[2]]);break;case 4:$=new Float32Array,n.map((e,a)=>{$=[...$,[l,p,h,l+E,p+T,h+P],[f,g,v,f+w,g+I,v+A],[y,x,b,y+F,x+L,b+M],[B,U,k,B+N,U+z,k+O]]}),n=$,u.vertices=[...u.vertices,...o[0],...o[1],...o[2],...o[2],...o[3],...o[0]],i.length&&(u.uvs=[...u.uvs,...i[0],...i[1],...i[2],...i[2],...i[3],...i[0]]),n.length&&(u.normals=[...u.normals,...n[0],...n[1],...n[2],...n[2],...n[3],...n[0]])}})}),cache.objFiles=[...structuredClone(cache.objFiles),{url:e,ret:u}]}for(var v=0;v<u.uvs.length;v+=2)u.uvs[v+1]=1-u.uvs[v+1];for(var v=0;v<u.normals.length;v+=3)u.normals[v+1]=-u.normals[v+1];for(var v=0;v<u.vertices.length;v+=3){p=u.vertices[v+0];var y=[p,h=u.vertices[v+1],f=u.vertices[v+2]];R_pyr(...y,{roll:i,pitch:n,yaw:c}),u.vertices[v+0]=y[0],u.vertices[v+1]=y[1],u.vertices[v+2]=y[2];for(var x=2;x--;){var b=x?2*v:2*v+3;p=u.normals[b+0];var y=[p,h=u.normals[b+1],f=u.normals[b+2]];y=R_rpy(...y,{roll:i,pitch:n,yaw:c}),u.normals[b+0]=y[0],u.normals[b+1]=y[1],u.normals[b+2]=y[2]}}return u},Q=(e,a,r,t,o=700)=>[t.width/2+e/r*o,t.height/2+a/r*o],R=(e,a,r,t,o=!1)=>{var i,n,c=Math,s=c.hypot,l=c.atan2,$=t.roll,p=t.pitch,h=t.yaw;if(e=S(i=l(e,a)+$)*(n=s(e,a)),a=C(i)*n,e=S(i=l(e,r)+h)*(n=s(e,r)),r=C(i)*n,a=S(i=l(a,r)+p)*(n=s(a,r)),r=C(i)*n,o){var f=t.x,u=t.y,m=t.z;e+=f,a+=u,r+=m}return[e,a,r]},R_ypr=(e,a,r,t,o=!1)=>{var i,n,c=Math,s=c.hypot,l=c.atan2,$=t.roll,p=t.pitch,h=t.yaw;if(e=S(i=l(e,r)+h)*(n=s(e,r)),r=C(i)*n,a=S(i=l(a,r)+p)*(n=s(a,r)),r=C(i)*n,e=S(i=l(e,a)+$)*(n=s(e,a)),a=C(i)*n,o){var f=t.x,u=t.y,m=t.z;e+=f,a+=u,r+=m}return[e,a,r]},R_pyr=(e,a,r,t,o=!1)=>{var i,n,c=Math,s=c.hypot,l=c.atan2,$=t.roll,p=t.pitch,h=t.yaw;if(a=S(i=l(a,r)+p)*(n=s(a,r)),r=C(i)*n,e=S(i=l(e,r)+h)*(n=s(e,r)),r=C(i)*n,e=S(i=l(e,a)+$)*(n=s(e,a)),a=C(i)*n,o){var f=t.x,u=t.y,m=t.z;e+=f,a+=u,r+=m}return[e,a,r]},R_rpy=(e,a,r,t,o=!1)=>{var i,n,c=Math,s=c.hypot,l=c.atan2,$=t.roll,p=t.pitch,h=t.yaw;if(e=S(i=l(e,a)+$)*(n=s(e,a)),a=C(i)*n,a=S(i=l(a,r)+p)*(n=s(a,r)),r=C(i)*n,e=S(i=l(e,r)+h)*(n=s(e,r)),r=C(i)*n,o){var f=t.x,u=t.y,m=t.z;e+=f,a+=u,r+=m}return[e,a,r]},LoadGeometry=async(e,a)=>{let r=e.gl;var t,o,i,n,c,s,l,$,p,h,f,u,m,_,d,g,v,y,x,b,E,T,P,w,I,A,F=!1,L=0,M=0,B=0,U=0,k=0,N=0,z=1,O=1,V=1,D=1,H=1,G=0,X=0,Y=16,q=40,W="",g="",K=1,j=!1,Z=0,J=0,ee=3355443,ea=.1,er=-1,et=-1,eo=!1,ei=!1,en=!1,ec="",es="",el=1,e$=!1,P=-1,ep=!0,I=8978210,w=!1,eh=0,ef=0,eu=0,em=!1,e_=0,ed=1,eg=!0,ev="image",e0=!1,ey=!1,eR=1,ex=1,eb=new Float32Array,eE=new Float32Array,eT={};Object.keys(a).forEach((e,r)=>{"showsource"===e.toLowerCase()&&(e0=!!a[e])}),Object.keys(a).forEach((e,r)=>{switch(e.toLowerCase()){case"x":L=a[e];break;case"y":M=a[e];break;case"z":B=a[e];break;case"roll":U=a[e];break;case"pitch":k=a[e];break;case"yaw":N=a[e];break;case"shapetype":switch(v=a[e].toLowerCase()){case"sprite":ec=`${ModuleBase}/resources/sprite.png`;break;case"point light":ec=e0?`${ModuleBase}/resources/stars/star.png`:""}break;case"size":K=a[e];break;case"subs":Z=a[e];break;case"equirectangular":er=!!a[e];break;case"equirectangularheightmap":et=!!a[e];break;case"flipnormals":ei=!!a[e];break;case"shownormals":en=!!a[e];break;case"sphereize":J=a[e];break;case"objx":t=a[e];break;case"objy":o=a[e];break;case"objz":i=a[e];break;case"objroll":n=a[e];break;case"objpitch":c=a[e];break;case"objyaw":s=a[e];break;case"scaleuvx":D=a[e];break;case"scaleuvy":H=a[e];break;case"offsetuvx":G=a[e];break;case"offsetuvy":X=a[e];break;case"scalex":z=a[e];break;case"scaley":O=a[e];break;case"scalez":V=a[e];break;case"wireframe":em=!!a[e];break;case"name":g=a[e];break;case"color":ee=a[e];break;case"colormix":ea=a[e];break;case"exportshape":F=!!a[e];break;case"penumbra":e_=a[e];break;case"url":W=a[e];break;case"map":ec=a[e];break;case"heightmap":es=a[e];break;case"heightmapintensity":el=a[e];break;case"heightmapiscanvas":e$=!!a[e];break;case"rows":Y=a[e];break;case"disabledepthtest":ey=a[e];break;case"cols":q=a[e];break;case"canvastexturemix":P=a[e];break;case"canvastexture":T=a[e],ev="canvas";break;case"involvecache":eg=!!a[e];break;case"muted":ep=!!a[e];break;case"lum":eR=a[e];break;case"alpha":ex=a[e];break;case"geometrydata":eb=a[e];break;case"precomputenormalassocs":eo=a[e];break;case"texcoords":eE=a[e];break;case"boundingcolor":I=a[e];break;case"showbounding":w=!!a[e];break;case"issprite":eh=a[e]?1:0;break;case"islight":ef=a[e]?1:0;break;case"issprite":eu=a[e]?1:0;break;case"playbackspeed":ed=a[e];break;case"averagenormals":eo=j=a[e];break;default:eT[e]=a[e]}}),void 0!==a.canvasTexture?(-1==P&&(P=1),eM=a.canvasTexture,delete a.canvasTexture):P=0,a.heightMapIsCanvas&&(eB=a.heightMap,delete a.heightMap),a=structuredClone(a),void 0!==eM&&(a.canvasTexture=eM),void 0!==eB&&(a.heightMap=eB);var e8=new Float32Array,eP=new Float32Array,ew=new Float32Array,eI=new Float32Array,eA=!1,eS=!1;if(-1!=v.indexOf("custom shape"))eU=W,ek=`${v} ${g} (${W})`;else if(ek=`${v}_${Z}`,Z<5&&ek)switch(ek){case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"cylinder_0":case"torus_0":case"torus knot_0":if("cylinder_0"!=ek||"torus_0"!=ek||"cylinder_0"==ek&&16==Y&&40==q||"torus_0"==ek&&16==Y&&40==q||"torus knot_0"==ek&&16==Y&&40==q){if(eA=!0,eU=`${W=`${ModuleBase}/new%20shapes/`}${ek}.json`,eg&&(cacheItem=cache.geometry.filter(e=>e.url==eU)).length){console.log(`found geometry (${ek}) in cache... using it`);var e1=cacheItem[0].data;e8=new Float32Array(e1.vertices),eP=new Float32Array(e1.normals),ew=new Float32Array(e1.normalVecs),eI=new Float32Array(e1.uvs),eS=!0,eA=!0}else await fetch(eU).then(e=>e.json()).then(e=>{e8=e.vertices,eP=e.normals,ew=e.normalVecs,eI=e.uvs,cache.geometry.push({data:structuredClone(e),url:eU})}),eA=!0}}if(!eA&&"custom shape"===v){if(eg&&(cacheItem=cache.customShapes.filter(e=>e.url==W)).length){console.log("found custom shape in cache... using it");var e1=cacheItem[0].data;e8=e1.vertices,eP=e1.normals,ew=e1.normalVecs,eI=e1.uvs,eA=!0,eS=!0}eA||await fetch(eU).then(e=>e.json()).then(e=>{e8=e.vertices,eP=e.normals,ew=e.normalVecs,eI=e.uvs,eA=!0,cache.customShapes.push({data:structuredClone(e),url:W})})}if(eA)switch(v){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":-1==er&&(er=!0),-1==et&&(et=!0)}else switch(v){case"tetrahedron":-1==er&&(er=!0),-1==et&&(et=!0),(A=await Tetrahedron(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"octahedron":-1==er&&(er=!0),-1==et&&(et=!0),(A=await Octahedron(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"icosahedron":-1==er&&(er=!0),-1==et&&(et=!0),(A=await Icosahedron(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"torus":(A=await Torus(K,Z,J,ei,v,Y,q)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"torus knot":(A=await TorusKnot(K,Z,Y,q,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"cylinder":(A=await Cylinder(K,Z,Y,q,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"dynamic":(A=await GeometryFromRaw(eb,eE,K,Z,J,ei,!!eb.filter(e=>4==e.length).length,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],void 0!==e.texCoord&&e.texCoord.length&&(eI=[...eI,...e.texCoord])});break;case"cube":(A=await Cube(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"rectangle":(A=await Rectangle(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"sprite":eh=!0,(A=await Rectangle(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"particles":eu=1,eb.map(e=>{e8=[...e8,...e]});break;case"point light":ef=!0,(A=e0?await Rectangle(Math.max(K,.5),Z+1,J,ei,v):{geometry:[]}).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]});break;case"obj":void 0===t&&(t=0),void 0===o&&(o=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===c&&(c=0),void 0===s&&(s=0),e8=(A=await LoadOBJ(W,K,t,o,i,n,c,s,!1)).vertices,eP=A.normals,eI=A.uvs;break;case"dodecahedron":-1==er&&(er=!0),-1==et&&(et=!0),(A=await Dodecahedron(K,Z,J,ei,v)).geometry.map(e=>{e8=[...e8,...e.position],eP=[...eP,...e.normal],eI=[...eI,...e.texCoord]})}if(0!=G||0!=X)for(var eC=0;eC<eI.length;eC+=2)eI[eC+0]+=G,eI[eC+1]+=X;if(1!=D||1!=H)for(var eC=0;eC<eI.length;eC+=2)eI[eC+0]*=D,eI[eC+1]*=H;if("particles"!=v&&("custom shape"!=v&&"obj"!=v||J||z||O||V))for(var eF=J,eL=1-J,eC=0;eC<e8.length;eC+=3){var eM,eB,eU,ek,eN,ez,e3,eO=e8[eC+0],eV=e8[eC+1],eD=e8[eC+2];ez=Math.hypot(eO,eV,eD)+1e-4,eO/=ez,eV/=ez,eD/=ez,eO*=eF+ez*eL,eV*=eF+ez*eL,eD*=eF+ez*eL,e8[eC+0]=eO*K*z,e8[eC+1]=eV*K*O,e8[eC+2]=eD*K*V;var eH=eP[2*eC+0],e2=eP[2*eC+1],eG=eP[2*eC+2];eP[2*eC+0]+=e8[eC+0]-eH,eP[2*eC+1]+=e8[eC+1]-e2,eP[2*eC+2]+=e8[eC+2]-eG,eP[2*eC+3]+=e8[eC+0]-eH,eP[2*eC+4]+=e8[eC+1]-e2,eP[2*eC+5]+=e8[eC+2]-eG}if(t||o||i||n||c||s){void 0===t&&(t=0),void 0===o&&(o=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===c&&(c=0),void 0===s&&(s=0);for(var eX,eC=0;eC<eP.length;eC+=6)L=eP[eC+0],eX=R(eO,eV=eP[eC+1],eD=eP[eC+2],{roll:n,pitch:c,yaw:s},!1),eP[eC+0]=eX[0]+t,eP[eC+1]=eX[1]+o,eP[eC+2]=eX[2]+i,L=eP[eC+3],eX=R(eO,eV=eP[eC+4],eD=eP[eC+5],{roll:n,pitch:c,yaw:s},!1),eP[eC+3]=eX[0]+t,eP[eC+4]=eX[1]+o,eP[eC+5]=eX[2]+i;for(var eC=0;eC<e8.length;eC+=3)L=e8[eC+0],eX=R(eO,eV=e8[eC+1],eD=e8[eC+2],{roll:n,pitch:c,yaw:s},!1),e8[eC+0]=eX[0]+t,e8[eC+1]=eX[1]+o,e8[eC+2]=eX[2]+i}if(j&&AverageNormals(e8,eP,v),"dynamic"==v||eo){eT.normalAssocs=new Float32Array;for(var eC=0;eC<e8.length;eC+=3){for(var eY=e8[eC+0],e4=e8[eC+1],eq=e8[eC+2],eW=new Float32Array,e6=0;e6<e8.length;e6+=3){var e7=e8[e6+0],eK=e8[e6+1],ej=e8[e6+2];.001>Math.hypot(eY-e7,e4-eK,eq-ej)&&(eW=[...eW,e6])}eT.normalAssocs=[...eT.normalAssocs,eW]}}if(!eS||!eA||j||F){ew=new Float32Array;for(var eC=0;eC<eP.length;eC+=6){let e9=eP[eC+3]-eP[eC+0],eZ;ew=[...ew,e9,eP[eC+4]-eP[eC+1],eP[eC+5]-eP[eC+2]]}}if(ei&&!F){for(var eC=0;eC<eP.length;eC+=6)eP[eC+3]=eP[eC+0]-(eP[eC+3]-eP[eC+0]),eP[eC+4]=eP[eC+1]-(eP[eC+4]-eP[eC+1]),eP[eC+5]=eP[eC+2]-(eP[eC+5]-eP[eC+2]);for(var eC=0;eC<ew.length;eC+=3)ew[eC+0]*=-1,ew[eC+1]*=-1,ew[eC+2]*=-1}if(F&&"background"!==g){var e5=document.createElement("div");e5.style.position="fixed",e5.style.zIndex=1e5,e5.style.left="50%",e5.style.top="50%",e5.style.transform="translate(-50%, -50%)",e5.style.background="#0008",e5.style.padding="20px",e5.style.width="600px",e5.style.height="350px",e5.style.border="1px solid #fff4",e5.style.borderRadius="5px",e5.style.fontFamily="monospace",e5.style.fontSize="20px",e5.style.color="#fff";var eQ=document.createElement("div");eQ.style.fontSize="24px",eQ.style.color="#0f8c",eQ.innerHTML=`Export Coordinates File -> ${v} `+(a?.name?`(${a.name})`:"")+"<br><br>",e5.appendChild(eQ);var eJ=document.createElement("div");eJ.style.minWidth="100%",eJ.style.height="250px",eJ.style.background="#333",eJ.style.border="1px solid #fff4",eJ.style.overflowY="auto",eJ.style.wordWrap="break-word",eJ.style.color="#888",eJ.style.fontSize="10px",e5.appendChild(eJ);var ae=document.createElement("button");ae.style.border="none",ae.style.padding="3px",ae.style.cursor="pointer",ae.fontSize="20px",ae.style.borderRadius="10px",ae.style.margin="10px",ae.style.minWidth="100px",ae.innerHTML="\uD83D\uDCCB copy",ae.title="copy shape data to clipboard",ae.onclick=()=>{var e=document.createRange();e.selectNode(eJ),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),ae.innerHTML="COPIED!",setTimeout(()=>{ae.innerHTML="\uD83D\uDCCB copy"},1e3)},e5.appendChild(ae);var aa=document.createElement("button");aa.onclick=()=>e5.remove(),aa.style.border="none",aa.style.padding="3px",aa.style.cursor="pointer",aa.fontSize="20px",aa.style.borderRadius="10px",aa.style.margin="10px",aa.style.background="#faa",aa.style.minWidth="100px",aa.innerHTML="close",e5.appendChild(aa);var ar={vertices:[],normals:[],normalVecs:[],uvs:[]};e8.map(e=>ar.vertices.push(Math.round(1e3*e)/1e3));for(var eC=0;eC<eP.length;eC+=6){var eY=eP[eC+0],e4=eP[eC+1],eq=eP[eC+2],e7=ei?eP[eC+0]-(eP[eC+3]-eP[eC+0]):eP[eC+3],eK=ei?eP[eC+1]-(eP[eC+4]-eP[eC+1]):eP[eC+4],ej=ei?eP[eC+2]-(eP[eC+5]-eP[eC+2]):eP[eC+5];eY=Math.round(1e3*eY)/1e3,e4=Math.round(1e3*e4)/1e3,eq=Math.round(1e3*eq)/1e3,e7=Math.round(1e3*e7)/1e3,eK=Math.round(1e3*eK)/1e3,ej=Math.round(1e3*ej)/1e3,ar.normals.push(eY,e4,eq,e7,eK,ej)}for(var eC=0;eC<ew.length;eC++)ar.normalVecs.push((ei?-1:1)*Math.round(1e3*ew[eC])/1e3);eI.map(e=>ar.uvs.push(Math.round(1e3*e)/1e3)),eJ.innerHTML=JSON.stringify(ar),document.body.appendChild(e5)}eS||(e8=new Float32Array(e8),eP=new Float32Array(eP),ew=new Float32Array(ew),eI=new Float32Array(eI)),l=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,l),r.bufferData(r.ARRAY_BUFFER,e8,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),y=new Uint32Array(Array(e8.length/3).fill().map((e,a)=>a)),$=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,$),r.bufferData(r.ELEMENT_ARRAY_BUFFER,y,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),u=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,u),r.bufferData(r.ARRAY_BUFFER,ew,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),b=new Uint32Array(Array(ew.length/3).fill().map((e,a)=>a)),m=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,m),r.bufferData(r.ELEMENT_ARRAY_BUFFER,b,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),p=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,p),r.bufferData(r.ARRAY_BUFFER,eP,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),x=new Uint32Array(Array(eP.length/3).fill().map((e,a)=>a)),h=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,h),r.bufferData(r.ELEMENT_ARRAY_BUFFER,x,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),_=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,_),r.bufferData(r.ARRAY_BUFFER,eI,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null),E=new Uint32Array(Array(eI.length/2).fill().map((e,a)=>a)),d=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,d),r.bufferData(r.ELEMENT_ARRAY_BUFFER,E,r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),-1==er&&(er=!1),-1==et&&(et=!1);var at={x:L,y:M,z:B,roll:U,pitch:k,yaw:N,color:ee,colorMix:ea,size:K,subs:Z,name:g,url:W,averageNormals:j,showNormals:en,shapeType:v,exportShape:F,sphereize:J,equirectangular:er,flipNormals:ei,vertices:e8,normals:eP,normalVecs:ew,uvs:eI,vertex_buffer:l,Vertex_Index_Buffer:$,normal_buffer:p,Normal_Index_Buffer:h,muted:ep,normalVec_buffer:u,NormalVec_Index_Buffer:m,nVecIndices:b,uv_buffer:_,UV_Index_Buffer:d,vIndices:y,nIndices:x,uvIndices:E,map:ec,video:f,textureMode:ev,isSprite:eh,isLight:ef,playbackSpeed:ed,disableDepthTest:ey,lum:eR,alpha:ex,involveCache:eg,renderer:e,isParticle:eu,penumbra:e_,wireframe:em,canvasTexture:T,canvasTextureMix:P,showBounding:w,boundingColor:I,heightMap:es,heightMapIntensity:el,heightMapIsCanvas:e$,equirectangularHeightmap:et};return Object.keys(at).forEach((e,a)=>{eT[e]=at[e]}),"particles"==v?await e.particleShader.ConnectGeometry(eT):(("point light"==v||"sprite"==v)&&(void 0===a.color&&(eT.color=11184810),"point light"==v&&(eT.pointLightID=e.pointLights.length,e.pointLights.push(eT))),await e.nullShader.ConnectGeometry(eT)),eT},GenericPopup=async(e="",a=!1,r=()=>{},t=400,o=300)=>{var i=document.createElement("div");i.className="genericPopup",i.style.position="fixed",i.style.zIndex=1e5,i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)",i.style.background="#0008",i.style.padding="20px",i.style.width=`${t}px`,i.style.height=`${o}px`,i.style.border="1px solid #fff4",i.style.borderRadius="5px",i.style.fontFamily="monospace",i.style.fontSize="20px",i.style.color="#fff";var n=document.createElement("div");if(n.style.fontSize="24px",n.style.color="#0f8c",n.innerHTML=e,i.appendChild(n),a){var c=document.createElement("button");c.onclick=()=>{r(),i.remove()},c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="SURE!",i.appendChild(c)}var s=document.createElement("button");s.onclick=()=>i.remove(),s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.background="#faa",s.style.minWidth="100px",s.innerHTML="close",i.appendChild(s),document.body.appendChild(i)},ImageToPo2=e=>{let a=e;if(!(IsPowerOf2(e.width)&&IsPowerOf2(e.height))){let r=document.createElement("canvas"),t=r.getContext("2d",{imageSmoothingEnabled:!0}),o=8,i=0,n=6e6,c,s,l=Math.hypot(e.width,e.height);for(let $=0;$<16;$++)(c=Math.abs(i-l))<n&&(n=c,i=o*2**$,s=$);i-=o*2**(s-1),r.width=i,r.height=i,t.drawImage(e,0,0,r.width,r.height),a=new Image,a=r}return a},VideoToImage=e=>{if(void 0!==e){let a,r;if(scratchCanvas.width!=e.videoWidth||scratchCanvas.height!=e.videoHeight?(a=e.videoWidth,r=e.videoHeight):(a=scratchCanvas.width,r=scratchCanvas.height),!(IsPowerOf2(a)&&IsPowerOf2(r))){let t=8,o=0,i=6e6,n,c,s=Math.hypot(a,r);for(let l=0;l<12;l++)(n=Math.abs(o-s))<i&&(i=n,o=t*2**l,c=l);o-=t*2**(c-1),a=(o=Math.min(512,o))/1,r=o/1}(scratchCanvas.width!=a||scratchCanvas.width!=r)&&(scratchCanvas.width=a,scratchCanvas.height=r),sctx.drawImage(e,0,0,a,r)}else scratchCanvas.width=1,scratchCanvas.height=1;return scratchCanvas},BindImage=(e,a,r,t="image",o=-1,i="",n=!0)=>{let c;switch(t){case"canvas":case"heightImage":c=a;break;case"video":n&&(cacheItem=cache.texImages.filter(e=>e.url==i&&-1!=o&&e.tVal==o)).length?(console.log("found video texture in cache... using it"),c=cacheItem[0].texImage):(c=VideoToImage(a),-1==o&&cache.texImages.push({url:i,tval:o,texImage:c}));break;case"image":n&&(cacheItem=cache.texImages.filter(e=>e.url==i)).length?(console.log("found image texture in cache... using it"),c=cacheItem[0].texImage):(c=ImageToPo2(a),-1==o&&cache.texImages.push({url:i,tval:o,texImage:c}))}e.bindTexture(e.TEXTURE_2D,r),c.width&&c.height&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,c),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)},SyncNormals=(e,a=!1,r=!1)=>{for(var t,o,i,n,c,s=e.vertices,l=new Float32Array,n=new Float32Array,$=0;$<s.length;$+=3)if(t=s[$+0],n=[...n,[t,o=s[$+1],i=s[$+2]]],$%9==6){var p=Normal(n);l=[...l,p,p,p],n=new Float32Array}if(a){for(var h=new Float32Array,$=0;$<s.length;$+=3){var f=s[$+0],u=s[$+1],m=s[$+2],_=$/3|0,d=l[_][3]-l[_][0],g=l[_][4]-l[_][1],v=l[_][5]-l[_][2],y=0;c=[0,0,0],e.normalAssocs[_].map(e=>{var a=e/3|0;c[0]+=l[a][3]-l[a][0],c[1]+=l[a][4]-l[a][1],c[2]+=l[a][5]-l[a][2],y++}),c[0]/=y,c[1]/=y,c[2]/=y,h=[...h,...c],e.normals[2*$+0]=f,e.normals[2*$+1]=u,e.normals[2*$+2]=m,e.normals[2*$+3]=f+c[0]*(r?-1:1),e.normals[2*$+4]=u+c[1]*(r?-1:1),e.normals[2*$+5]=m+c[2]*(r?-1:1)}for(var p=e.normalVecs,$=0;$<p.length;$++)p[$]=h[$]}},GetShaderCoord=(e,a,r,t,o,i=0,n=0,c=0,s=0,l=0,$=!1,p=!0,h=0)=>{if(t.heightMap&&SHMdata.length){if(t.equirectangularHeightmap){var f,u,m,_,d,g,v,y,x=e,b=a,E=r,T=Math.hypot(x,b,E);d=[v=(g=Math.atan2(x,E))/Math.PI/2,y=Math.acos(b/(Math.hypot(x,b,E)+1e-5))/Math.PI]}else d=[s,l];var P,w,I=((scratchHeightMap.width*d[0]|0)+(scratchHeightMap.height*scratchHeightMap.width*d[1]|0))*4,A=SHMdata[I+0]/256,F=(A+SHMdata[I+1]/256+SHMdata[I+2]/256)/3*t.heightMapIntensity/2;e+=i*F,a+=n*F,r+=c*F}a*=-1,e=(_=R_ypr(e,a,r,{roll:-t.roll+.01,pitch:-t.pitch,yaw:t.yaw},!1))[0],a=_[1],r=_[2],t.isLight&&(e=(_=R_rpy(e,a,r,{roll:o.roll,pitch:o.pitch,yaw:-o.yaw},!1))[0],a=_[1],r=_[2]);var L=o.x,M=o.y,B=o.z;e+=t.x,a-=t.y,r+=t.z,"fps"==o.cameraMode.toLowerCase()?(e+=L,a-=M,r+=B,e=(_=R_ypr(e,a,r,{roll:-o.roll,pitch:-o.pitch,yaw:o.yaw},!1))[0],a=_[1],r=_[2],L=0,M=0,B=0):(e=(_=R_ypr(e,a,r,{roll:-o.roll,pitch:-o.pitch,yaw:o.yaw},!1))[0],a=_[1],r=_[2]),k=e,N=a,z=r;var U=!1;if($){f=k+L;var k,N,z,v,O,T=Math.hypot(f,u=N-M,m=z+B);p?v=Math.atan2(f,m)/Math.PI:0==h?(g=Math.atan2(f,m)+Math.PI/2,O=Math.hypot(f,m),f=S(g)*O,m=C(g)*O,U=(v=(Math.atan2(f,m)/Math.PI+2)%2-1)<=-1,v+=.5):(g=Math.atan2(f,m)-Math.PI/2,O=Math.hypot(f,m),f=S(g)*O,m=C(g)*O,U=(v=(Math.atan2(f,m)/Math.PI+2)%2-1)>=1,v-=.5);var y=-(Math.acos(u/(T+1e-4))/Math.PI*2-1);return!U&&[o.width/2+v*o.width/2,o.height/2+y*o.height/2,T]}e+=L,a-=M,r-=B;var V,D=o.fov;return(m=r+(B/1e3*Math.pow(5,Math.log(D)/1.609438)+B))>0&&[f=o.width/2+e/m*D/2,u=o.height/2+a/m*D/2,m]},ShowBounding=(e,a,r=!0,t=-1,o=!0,i=0)=>{if(-1==t&&(t=a.equirectangularPlugin),e.isLight)return[];var n,c,s,l,$,p,h,f,u,m=[],_=[];let d=(e,a,t=-1,o=9)=>{t!=a&&(t=a,m=[...m,a],n=e[a][0],c=e[a][1],P=w=-9,e.map((r,t)=>{t!=a&&(s=e[t][0],(x=Math.atan2((l=e[t][1])-c-1e-5,n-s))>=P&&x<=o&&(P=x,w=t))}),-9!=w&&(r&&(_=[..._,[...e[w]]]),d(e,w,t,P)))};var g,v,y,n,c,s,l,$,p,h,f,x,b,E,T,P,w,I,A,F,L,M,B,U,k,N,E=[],z=-1,O=1e6,V=3,D=e.shader.datasets[e.datasetIdx];e.heightMap&&("video"==e.heightTextureMode?(scratchHeightMap.width=D.heightResource.videoWidth/2,scratchHeightMap.height=D.heightResource.videoHeight/2):(scratchHeightMap.width=D.heightResource.width/2,scratchHeightMap.height=D.heightResource.height/2),SHMctx.drawImage(D.heightResource,0,0,scratchHeightMap.width,scratchHeightMap.height),SHMdata=scratchHeightMap.width?SHMctx.getImageData(0,0,scratchHeightMap.width,scratchHeightMap.height).data:[]);for(var H=0;H<e.vertices.length;H+=V){(e.isParticle||!(H%9))&&(F=L=0,T=[]),g=e.vertices[H+0],v=e.vertices[H+1],y=e.vertices[H+2],M=H+0<e.normalVecs.length?e.normalVecs[H+0]:0,B=H+1<e.normalVecs.length?e.normalVecs[H+1]:0,U=H+2<e.normalVecs.length?e.normalVecs[H+2]:0;var G=(H/V|0)*2;k=G+0<e.uvs.length?e.uvs[G+0]:0,N=G+1<e.uvs.length?e.uvs[G+1]:0;var X=GetShaderCoord(g,v,y,e,a,M,B,U,k,N,t,o,i);X&&(T=[...T,[X[0],X[1]]],F+=X[0],L+=X[1],(e.isParticle||H%9==6)&&Math.hypot((F/=V)-z,(L/=V)-O)>10&&(z=F,O=L,E=[...E,T]))}e.isParticle?(T=[],E.map((e,a)=>{n=e[0][0],c=e[0][1],T.filter(e=>e[0]==n&&e[1]==c).length||(T=[...T,[n,c]])})):(T=[],E.map((e,a)=>{e.length>2&&(n=e[0][0],c=e[0][1],s=e[1][0],l=e[1][1],$=e[2][0],p=e[2][1],T.filter(e=>e[0]==n&&e[1]==c).length||(T=[...T,[n,c]]),T.filter(e=>e[0]==s&&e[1]==l).length||(T=[...T,[s,l]]),T.filter(e=>e[0]==$&&e[1]==p).length||(T=[...T,[$,p]]))}));var Y=6e6,q=-1;if(T.map((e,a)=>{e[1]<=Y&&(q=a,Y=e[1])}),T.length&&(d(T,q),r)){var W=RGBFromHex(e.boundingColor);overlay.ctx.strokeStyle=`rgba(${256*W[0]},${256*W[1]},${256*W[2]},.5)`,overlay.ctx.globalAlpha=1,overlay.ctx.beginPath(),_.map((e,a)=>{overlay.ctx.lineWidth=10;var r=_[a][0],t=_[a][1],n=_[u=(a+1)%_.length][0],c=_[u][1];o?(overlay.ctx.moveTo(r,t),overlay.ctx.lineTo(n,c)):0==i?r>=overlay.width/2-overlay.width/8&&r<overlay.width+overlay.width/8&&n>=overlay.width/2-overlay.width/8&&n<overlay.width+overlay.width/8&&(overlay.ctx.moveTo(r,t),overlay.ctx.lineTo(n,c)):r<=overlay.width/2+overlay.width/8&&r>-overlay.width/8&&n<=overlay.width/2+overlay.width/8&&n>-overlay.width/8&&(overlay.ctx.moveTo(r,t),overlay.ctx.lineTo(n,c))}),overlay.ctx.stroke()}return m.map(e=>[T[e][0],T[e][1]])},AverageNormals=(e,a,r)=>{a.length=0;for(var t,o,i,n,c,s,l,$,p,h,f,u,m,_,d,g,v,y,x=IsPolyhedron(r),b=0;b<e.length;b+=3)b%9||(t=Normal([[e[b+0],e[b+1],e[b+2]],[e[b+3],e[b+4],e[b+5]],[e[b+6],e[b+7],e[b+8]]],x)),a[2*b+0]=e[b+0],a[2*b+1]=e[b+1],a[2*b+2]=e[b+2],a[2*b+3]=e[b+0]+(t[0]-t[3]),a[2*b+4]=e[b+1]+(t[1]-t[4]),a[2*b+5]=e[b+2]+(t[2]-t[5]);for(var E=new Float32Array,T=structuredClone(a),b=0;b<a.length;b+=6){l=a[b+0],$=a[b+1],p=a[b+2],h=a[b+3],f=a[b+4],u=a[b+5],n=h,c=f,s=u,i=1;for(var P=0;P<a.length;P+=6)P!=b&&(m=a[P+0],_=a[P+1],d=a[P+2],g=a[P+3],v=a[P+4],y=a[P+5],.01>Math.hypot(l-m,$-_,p-d)&&(n+=g,c+=v,s+=y,i++));T[b+3]=n/=i,T[b+4]=c/=i,T[b+5]=s/=i}T.map((e,r)=>a[r]=e)},BasicShader=async(e,a=[])=>{let r=e.gl;var t,o={iURL:null,locT:null,locUv:null,locFov:null,program:null,heightMapURL:null,optionalUniforms:[],optionalLighting:[]};a.map(a=>{Object.keys(a).forEach((r,t)=>{switch(r.toLowerCase()){case"lighting":if("ambientlight"===a[r].type.toLowerCase()&&(void 0===a[r]?.enabled||a[r].enabled)){var i={name:a[r].type,value:void 0===a[r].value?e.ambientLight:a[r].value};o.optionalLighting.push(i)}break;case"uniform":switch(a[r].type.toLowerCase()){case"reflection":if(void 0===a[r]?.enabled||a[r].enabled){var n={name:a[r].type,playbackSpeed:void 0===a[r].playbackSpeed?1:a[r].playbackSpeed,involveCache:void 0===a[r].involveCache||a[r].involveCache,muted:void 0===a[r].muted||a[r].muted,map:a[r].map,loc:"locReflection",value:void 0===a[r].value?.5:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flipReflections:void 0!==a[r].flipReflections&&a[r].flipReflections,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:`
                  `,vertCode:`
                  `,fragDeclaration:`
                    uniform float reflection;
                    uniform float refFlatShading;
                    uniform float refOmitEquirectangular;
                    uniform float refFlipRefs;
                    uniform sampler2D reflectionMap;
                  `,fragCode:`
                    //light.rgb *= .5;
                    //light.rgb += .05;
                    float refP1, refP2;
                    if(refOmitEquirectangular != 1.0){
                      vec3 reflectionPos = R_ypr(nVi, geoOri);
                      float px = reflectionPos.x;
                      float py = reflectionPos.y;
                      float pz = reflectionPos.z;
                      refP1 = -atan(px, pz) / M_PI / 4.0;
                      refP2 = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;
                      if(refFlipRefs != 0.0) refP2 = 1.0 - refP2;
                    } else {
                      refP1 = vUv.x;
                      refP2 = vUv.y;
                    }
                    
                    vec2 refCoords = vec2(1.0 - refP1 * 2.0, refP2);
                    vec4 refCol = vec4(texture2D(reflectionMap, vec2(refCoords.x, refCoords.y)).rgb * 1.25, reflection / 1.0);
                    mixColor = merge(mixColor, refCol);
                    baseColorIp = 1.0 - reflection;
                    //light += reflection / 4.0;
                  `};o.optionalUniforms.push(n)}break;case"phong":if(void 0===a[r]?.enabled||a[r].enabled){var n={name:a[r].type,loc:"locPhong",value:void 0===a[r].value?.3:a[r].value,flatShading:void 0!==a[r].flatShading&&a[r].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[r].theta?.5:a[r].theta,dataType:"uniform1f",vertDeclaration:`
                  `,vertCode:`
                    hasPhong = 1.0;
                  `,fragDeclaration:`
                    uniform float phong;
                    uniform float phongTheta;
                    uniform float phongFlatShading;
                  `,fragCode:`
                    if(isLight == 0.0 &&
                       isSprite == 0.0 && isParticle == 0.0){
                      //light.rgb *= .5;
                      float phongP1, phongP2;
                      float px, py, pz;
                      if(phongFlatShading != 0.0){
                        px = 0.0;
                        py = 0.0;
                        pz = 0.0;
                      }else{
                        px = nV.x;
                        py = nV.y;
                        pz = nV.z;
                      }
                      phongP1 = atan(px, pz) + phongTheta;
                      phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)));

                      float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0-.2)), 3.0), 3.0) / 5e5 * phong ;
                      light = vec4(light.rgb + fact, 1.0) * 25.0;
                    }
                  `};o.optionalUniforms.push(n)}}}})});let i={ConnectGeometry:null,datasets:[]};if("2d"!=e.contextType){r.enable(r.DEPTH_TEST),r.cullFace(r.BACK),e.alpha&&(r.blendFunc(r.SRC_ALPHA,r.ONE),r.enable(r.BLEND),r.disable(r.DEPTH_TEST));let n="";o.optionalUniforms.map(e=>{n+="\n"+e.vertDeclaration+"\n"});let c="";o.optionalUniforms.map(e=>{c+="\n"+e.vertCode+"\n"});let s="";o.optionalUniforms.map(e=>{s+="\n"+e.fragDeclaration+"\n"});let l="";o.optionalUniforms.map(e=>{l+="\n"+e.fragCode+"\n"}),i.vert=`
      precision highp float;
      #define M_PI 3.14159265358979323
      attribute vec2 uv;
      ${n}
      
      uniform float t;
      uniform vec3 color;
      uniform float flatShading;
      uniform float ambientLight;
      uniform float plugin;
      uniform vec3 camPos;
      uniform vec3 camOri;
      uniform vec3 geoPos;
      uniform vec3 geoOri;
      uniform float omitSplitCheck;
      uniform float splitCheckPass;
      uniform float pointSize;
      uniform float isSprite;
      uniform float isLight;
      uniform float cameraMode;
      uniform float isParticle;
      uniform float penumbraPass;
      uniform float fov;
      uniform float equirectangular;
      uniform float equirectangularHeightmap;
      uniform float renderNormals;
      uniform vec2 resolution;
      uniform float useHeightMap;
      uniform float heightMapIntensity;
      uniform sampler2D heightMap;
      attribute vec3 position;
      attribute vec3 normal;
      attribute vec3 normalVec;
      varying vec2 vUv;
      varying vec2 uvi;
      varying vec3 nVec;
      varying vec3 nVeci;
      varying vec3 fPos;
      varying vec3 fPosi;
      varying float skip;
      varying float hasPhong;
      
      
      vec3 R(vec3 pos, vec3 rot){
        float p, d;
        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));
        pos.z = cos(p)*d;
        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));
        pos.z = cos(p)*d;
        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));
        pos.y = cos(p)*d;
        return pos;
      }
      
      void main(){
        
        hasPhong = 0.0;
        
        float cx, cy, cz;
        
        if(renderNormals == 1.0){
          cx = normal.x;
          cy = normal.y;
          cz = normal.z;
        }else{
          cx = position.x;
          cy = position.y;
          cz = position.z;
        }
        
        
/*
  var b1 = facet[2][0]-facet[1][0], b2 = facet[2][1]-facet[1][1], b3 = facet[2][2]-facet[1][2]
  var c1 = facet[1][0]-facet[0][0], c2 = facet[1][1]-facet[0][1], c3 = facet[1][2]-facet[0][2]
  crs = [b2*c3-b3*c2,b3*c1-b1*c3,b1*c2-b2*c1]
*/  
        
        if(useHeightMap != 0.0 && renderNormals == 0.0){
          nVeci = normalVec;
          vec4 h;
          float lum;

          if(equirectangularHeightmap != 0.0){
            float p;
            float p2;
            vec3 cpos = vec3(cx, cy, cz);
            p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(cpos.x, cpos.z);
            float p1;
            p1 = p / M_PI / 2.0;
            p2 = flatShading == 1.0 ?
                  acos(nVeci.y / (sqrt(nVeci.x*nVeci.x + nVeci.y*nVeci.y + nVeci.z*nVeci.z)+.00001)) / M_PI   :
                  acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;
            uvi = vec2(p1, p2);
          } else {
            uvi = uv;
          }

            
          h = texture2D( heightMap, uvi);
          lum = ((h.r + h.g + h.b) / 3.0) * (heightMapIntensity) / 2.0;
          cx += normalVec.x * lum;
          cy += normalVec.y * lum;
          cz += normalVec.z * lum;

          
        }else{
          uvi = uv / 2.0;
          uvi = vec2(uvi.x, .5 - uvi.y);
          nVeci = normalVec;
        }
        
        fPosi = vec3(cx, cy, cz);
        
        // camera rotation
        
        vec3 geo, pos;
        float cpx = camPos.x;
        float cpy = camPos.y;
        float cpz = camPos.z;
        
        if(cameraMode == 1.0){  // 'FPS' mode
          if(isSprite != 0.0 || isLight != 0.0){
            geo = R(geoPos, camOri);
            pos = R(vec3(cx, cy, cz), geoOri);
            pos.x += cpx;
            pos.y += cpy;
            pos.z += cpz;
            pos = R(vec3(pos.x, pos.y, pos.z), camOri);
            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);
            nVec = R(nVec, geoOri);
            nVec = R(nVec, vec3(0.0, camOri.y, camOri.z));
          }else{
            geo = R(geoPos, camOri);
            pos = R(vec3(cx, cy, cz), geoOri);
            pos.x += cpx;
            pos.y += cpy;
            pos.z += cpz;
            pos = R(vec3(pos.x, pos.y, pos.z), camOri);
            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);
            nVec = R(nVec, geoOri);
            nVec = R(nVec, vec3(0.0, camOri.y, camOri.z));
          }
          cpx = 0.0;
          cpy = 0.0;
          cpz = 0.0;
          fPos = vec3(pos.x, pos.y, pos.z);
        }else{
          if(isSprite != 0.0 || isLight != 0.0){
            geo = R(geoPos, camOri);
            pos = R(vec3(cx, cy, cz),
                     vec3(0.0, -camOri.y + M_PI, 0.0));
            pos = R(vec3(pos.x, pos.y, pos.z),
                     vec3(-camOri.x, 0.0, -camOri.z ));
            pos = R(vec3(pos.x, pos.y, pos.z), camOri);
            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);
            nVec = R(nVec, geoOri);
            nVec = R(nVec, vec3(0.0, camOri.y, camOri.z));
          }else{
            geo = R(geoPos, camOri);
            pos = R(vec3(cx, cy, cz), geoOri);
            pos = R(vec3(pos.x, pos.y, pos.z), camOri);
            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);
            nVec = R(nVec, geoOri);
            nVec = R(nVec, vec3(0.0, camOri.y, camOri.z));
          }
          fPos = vec3(pos.x, pos.y, pos.z);
        }
        
        ${c}
        
        float camz = cpz / 1e3 * pow(5.0, log(fov) / 1.609438);
        
        float X, Y;
        float Z = pos.z + camz + geo.z;
        if(isParticle != 0.0 && penumbraPass != 0.0) Z += .001;
        
        if( plugin ==  1.0 ){   // equirectangular post-processing plugin
          X = pos.x + cpx + geo.x;
          Y = pos.y + cpy + geo.y;
          Z = pos.z + cpz + geo.z;
          float dist = sqrt(X*X + Y*Y + Z*Z);
          float p1;
          if(omitSplitCheck == 0.0){
            if(splitCheckPass == 0.0){
              vec3 rot = R(vec3(X, Y, Z), vec3(0,0,M_PI/2.0));
              X = rot.x;
              Y = rot.y;
              Z = rot.z;
              p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;
              skip = p1 <= -0.75 ? 1.0 : 0.0;
              p1 += .5;
            }else{
              vec3 rot = R(vec3(X, Y, Z), vec3(0,0,-M_PI/2.0));
              X = rot.x;
              Y = rot.y;
              Z = rot.z;
              p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;
              skip = p1 >= 0.75 ? 1.0 : 0.0;
              p1 -= .5;
            }
          }else{
            skip = 0.0;
            p1 = atan(X, Z) / M_PI;
          }
          if(skip == 0.0){
            float p2 = - (acos(Y / (dist + .0001)) / M_PI * 2.0 - 1.0) * 1.05;
            gl_PointSize = 100.0 * pointSize / dist;
            gl_Position = vec4(p1, p2, dist/10000.0, 1.0);
            vUv = uv;
          }
        } else {  // default projection
          X = (pos.x + cpx + geo.x) / Z / resolution.x * fov;
          Y = (pos.y + cpy + geo.y) / Z / resolution.y * fov;
          if(Z > 0.0) {
            gl_PointSize = 100.0 * pointSize / Z;
            gl_Position = vec4(X, Y, Z/10000.0, 1.0);
            skip = 0.0;
            vUv = uv;
          }else{
            skip = 1.0;
          }
        }
      }
    `,i.frag=`
      precision highp float;
      #define M_PI 3.14159265358979323
      ${s}
      uniform float t;
      uniform vec2 resolution;
      uniform float plugin;
      uniform float flatShading;
      uniform float isSprite;
      uniform float isLight;
      uniform float isParticle;
      uniform float cameraMode;
      uniform vec4 pointLightPos[16];
      uniform vec4 pointLightCol[16];
      uniform int pointLightCount;
      uniform float ambientLight;
      uniform float renderNormals;
      uniform float equirectangular;
      uniform float equirectangularHeightmap;
      uniform float colorMix;
      //uniform float penumbraPass;
      uniform vec3 color;
      uniform float useHeightMap;
      uniform float heightMapIntensity;
      uniform sampler2D heightMap;
      uniform sampler2D baseTexture;
      uniform sampler2D supplementalTexture;
      uniform float supplementalTextureMix;
      uniform float alpha;
      uniform vec3 camPos;
      uniform vec3 camOri;
      uniform vec3 geoPos;
      uniform vec3 geoOri;
      varying vec2 vUv;
      varying vec2 uvi;
      varying vec3 nVec;
      varying vec3 nVeci;
      varying vec3 fPos;
      varying vec3 fPosi;
      varying float skip;
      varying float hasPhong;

      vec4 merge (vec4 col1, vec4 col2){
        return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);
      }
      
      vec2 Coords(float flatShading, vec3 nV) {
        vec2 ret;
        if(equirectangular == 1.0){
          float p;
          float p2;
          vec3 cpos = fPosi;
          p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;
          float p1;
          p1 = p / M_PI / 2.0;
          p2 = flatShading == 1.0 ?
                acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :
                p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;
          ret = vec2(p1, p2);
        }else{
          ret = vUv;
        }
        return ret;
      }

      vec3 R_ypr(vec3 pos, vec3 rot){
        float p, d;
        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));
        pos.z = cos(p)*d;
        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));
        pos.z = cos(p)*d;
        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));
        pos.y = cos(p)*d;
        return pos;
      }
      
      vec3 R_yrp(vec3 pos, vec3 rot){
        float p, d;
        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));
        pos.z = cos(p)*d;
        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));
        pos.y = cos(p)*d;
        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));
        pos.z = cos(p)*d;
        return pos;
      }
      
      vec4 GetPointLight(){
        
        float ret = 0.0;
        vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);
        for(int i=0; i < 16; i++){
          //if(i >= pointLightCount) break;
          vec3 lpos = pointLightPos[i].xyz;
          lpos.x -= geoPos.x; //- camPos.x;
          lpos.y -= geoPos.y; //- camPos.y;
          lpos.z -= geoPos.z; //- camPos.z;
          lpos = R_yrp(lpos, vec3(camOri.x, camOri.y, camOri.z ));

          float mag = pointLightPos[i].w;
          ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) + (lpos.y-fPos.y) * (lpos.y-fPos.y) +
          + (lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 40.0;
          
          rgba.r += ret * pointLightCol[i].r;
          rgba.g += ret * pointLightCol[i].g;
          rgba.b += ret * pointLightCol[i].b;
        }
        
        return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);
      }

      void main() {
        if(isParticle != 0.0){
          gl_FragColor = merge(gl_FragColor, vec4(color.rgb, alpha));
        }else{
          float mixColorIp = colorMix;
          float baseColorIp = 1.0 - mixColorIp;
          vec4 mixColor = vec4(color.rgb, mixColorIp);
          vec4 light = hasPhong == 1.0 ? GetPointLight() :
                vec4(ambientLight, ambientLight, ambientLight, 1.0);
          float colorMag = 1.0;
          if(skip != 1.0){
            if(renderNormals == 1.0){
              gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
            }else{
              float p;
              vec3 nV, nVi;
              if(useHeightMap != 0.0){
                
                float rad = .02;
                float rad2 = -.25;
                vec2 cr1, cr2, cr3;
                float lum1, lum2, lum3;
                for(float j=0.0; j<3.0; j+=1.0){
                  
                  float tx, ty;
                  p = M_PI * 2.0 / 3.0 * j;
                  tx = -sin(p) * rad;
                  ty = -cos(p) * rad;
                
                  vec2 hcoords;
                  if(equirectangularHeightmap == 1.0){
                    float p;
                    float p2;
                    vec3 cpos = fPosi;
                    p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;
                    float p1;
                    p1 = p / M_PI / 2.0;
                    p2 = flatShading == 1.0 ?
                          acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :
                          p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;
                    tx += p1;
                    ty += p2;
                    hcoords = vec2(tx, ty);
                  }else{
                    hcoords = vUv + vec2(tx, ty);
                  }
                  
                  vec4 htexel = texture2D( heightMap, hcoords);
                  float lum = (htexel.r + htexel.g + htexel.b) / 3.0;
                  if(j == 0.0) {
                    lum1 = lum;
                    cr1 = hcoords;
                  }
                  if(j == 1.0) {
                    lum2 = lum;
                    cr1 = hcoords;
                  }
                  if(j == 2.0) {
                    lum3 = lum;
                    cr2 = hcoords;
                  }
                }

                float a1 = cr1.x;
                float a2 = cr1.y;
                float a3 = (lum1 - 0.5) * rad2;
                
                float b1 = cr2.x - a1;
                float b2 = cr2.y - a2;
                float b3 = (lum2 - 0.5) * rad2 - a3;
                float c1 = cr3.x - cr2.x;
                float c2 = cr3.y - cr2.y;
                float c3 = (lum3 - 0.5) * rad2 - (lum2 - 0.5) * rad2;
                vec3 anorm =  vec3(b2*c3-b3*c2, b3*c1-b1*c3, b1*c2-b2*c1) * (1.0 + heightMapIntensity) / 2.0;
                nV = normalize( nVec + anorm);
                nVi = normalize( nVeci + anorm);
              }else{
                nV = nVec;
                nVi = nVeci;
              }
              
              
              ${l}
              vec2 coords = Coords(0.0, nVi);
              vec4 texel = texture2D( baseTexture, coords);
              texel = merge(texel, vec4(texture2D( supplementalTexture, coords).rgb, supplementalTextureMix));
              if(isSprite != 0.0 || isLight != 0.0){
                gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);
              }else{
                texel.a = baseColorIp;
                vec4 col = merge(mixColor, texel);
                col.rgb *= light.rgb;
                gl_FragColor = vec4(col.rgb * colorMag, 1.0);
              }
            }
          }
        }
      }
    `;let $=r.createShader(r.VERTEX_SHADER);r.shaderSource($,i.vert),r.compileShader($);let p=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(p,i.frag),r.compileShader(p),i.ConnectGeometry=async(a,t=!1)=>{var n=a.involveCache,c=structuredClone(o);i.datasets=[...i.datasets,c],c.program=r.createProgram(),r.attachShader(c.program,$),r.attachShader(c.program,p),r.linkProgram(c.program),a.shader=i;var s=a.map,l=a.heightMap;if(a.datasetIdx=i.datasets.length-1,r.getProgramParameter(c.program,r.LINK_STATUS)){if(r.useProgram(c.program),r.bindBuffer(r.ARRAY_BUFFER,a.vertex_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),c.locPosition=r.getAttribLocation(c.program,"position"),r.vertexAttribPointer(c.locPosition,3,r.FLOAT,!1,0,0),r.enableVertexAttribArray(c.locPosition),r.bindBuffer(r.ARRAY_BUFFER,a.uv_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),c.locUv=r.getAttribLocation(c.program,"uv"),r.vertexAttribPointer(c.locUv,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(c.locUv),r.bindBuffer(r.ARRAY_BUFFER,a.normal_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),c.locNormal=r.getAttribLocation(c.program,"normal"),r.vertexAttribPointer(c.locNormal,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(c.locNormal),r.bindBuffer(r.ARRAY_BUFFER,a.normalVec_buffer),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),c.locNormalVec=r.getAttribLocation(c.program,"normalVec"),r.vertexAttribPointer(c.locNormalVec,3,r.FLOAT,!0,0,0),r.enableVertexAttribArray(c.locNormalVec),!t){if(a.isLight||c.optionalUniforms.map(async e=>{switch(e.name){case"reflection":var t=e.map;if(t){let o,s=(o=t.split("."))[o.length-1].toLowerCase();switch(e.refTexture=r.createTexture(),s){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",n&&(cacheItem=cache.textures.filter(e=>e.url==t)).length?(console.log("found video in cache... using it"),e.video=cacheItem[0].resource,i.datasets=[...i.datasets,{texture:cacheItem[0].texture,iURL:t}]):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,i.datasets=[...i.datasets,{texture:e.refTexture,iURL:t}],e.video.loop=!0,e.muted||audioConsent||(audioConsent=!0,GenericPopup("play audio OK?",!0,()=>{cache.textures.filter(e=>e.url==t)[0].resource.muted=!1,cache.textures.filter(e=>e.url==t)[0].resource.currentTime=0,cache.textures.filter(e=>e.url==t)[0].resource.play()})),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},r.activeTexture(r.TEXTURE1),BindImage(r,e.video,e.refTexture,e.textureMode,-1,t),cache.textures.push({url:t,resource:e.video,texture:e.refTexture}),await fetch(t).then(e=>e.blob()).then(a=>{e.video.src=URL.createObjectURL(a)}));break;default:e.textureMode="image";var l,l=new Image;i.datasets=[...i.datasets,{texture:e.refTexture,iURL:t}],r.activeTexture(r.TEXTURE1),r.uniform1f(e.locRefFlipRefs,e.refTexture),r.bindTexture(r.TEXTURE_2D,e.refTexture),l.onload=()=>{BindImage(r,l,e.refTexture,e.textureMode,-1,t)},cache.textures.push({url:t,resource:l,texture:e.refTexture}),await fetch(t).then(e=>e.blob()).then(e=>{l.src=URL.createObjectURL(e)})}}r.useProgram(c.program),r.activeTexture(r.TEXTURE1),e.locRefOmitEquirectangular=r.getUniformLocation(c.program,"refOmitEquirectangular"),r.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType?1:0),e.locRefFlipRefs=r.getUniformLocation(c.program,"refFlipRefs"),r.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=r.getUniformLocation(c.program,"reflectionMap"),r.bindTexture(r.TEXTURE_2D,e.refTexture),r.uniform1i(e.locRefTexture,1),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,e.refTexture);break;case"phong":e.locPhongTheta=r.getUniformLocation(c.program,e.theta),r.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=r.getUniformLocation(c.program,e.flatShadingUniform),r.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=r.getUniformLocation(c.program,e.name),r[e.dataType](e.loc,e.value)}),c.locColor=r.getUniformLocation(c.program,"color"),r.uniform3f(c.locColor,...HexToRGB(a.color)),"particles"==a.shapeType&&(c.locPointSize=r.getUniformLocation(c.program,"pointSize"),r.uniform1f(c.locPointSize,a.size)),c.locColorMix=r.getUniformLocation(c.program,"colorMix"),r.uniform1f(c.locColorMix,a.colorMix),c.locIsSprite=r.getUniformLocation(c.program,"isSprite"),r.uniform1f(c.locIsSprite,a.isSprite?1:0),c.locCameraMode=r.getUniformLocation(c.program,"cameraMode"),r.uniform1f(c.locCameraMode,"fps"==e.cameraMode.toLowerCase()?1:0),c.locSupplementalTextureMix=r.getUniformLocation(c.program,"supplementalTextureMix"),r.uniform1f(c.locSupplementalTextureMix,a.canvasTextureMix),c.locIsLight=r.getUniformLocation(c.program,"isLight"),r.uniform1f(c.locIsLight,a.isLight?1:0),c.locIsParticle=r.getUniformLocation(c.program,"isParticle"),r.uniform1f(c.locIsParticle,a.isParticle?1:0),c.locPenumbraPass=r.getUniformLocation(c.program,"penumbraPass"),c.locAlpha=r.getUniformLocation(c.program,"alpha"),r.uniform1f(c.locAlpha,a.alpha),c.locPointLights=r.getUniformLocation(c.program,"pointLightPos[0]"),c.locPointLightCols=r.getUniformLocation(c.program,"pointLightCol[0]"),c.locPointLightCount=r.getUniformLocation(c.program,"pointLightCount"),r.uniform1i(c.locPointLightCount,0),c.locResolution=r.getUniformLocation(c.program,"resolution"),r.uniform2f(c.locResolution,e.width,e.height),c.locEquirectangular=r.getUniformLocation(c.program,"equirectangular"),r.uniform1f(c.locEquirectangular,a.equirectangular?1:0),c.locT=r.getUniformLocation(c.program,"t"),r.uniform1f(c.locT,0),c.locAmbientLight=r.getUniformLocation(c.program,"ambientLight"),r.uniform1f(c.locAmbientLight,e.ambientLight),c.texture=r.createTexture(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,c.texture),c.locTexture=r.getUniformLocation(c.program,"baseTexture"),a.heightMap&&(c.heightTexture=r.createTexture(),c.locHeightMap=r.getUniformLocation(c.program,"heightMap"),c.locEquirectangularHeightmap=r.getUniformLocation(c.program,"equirectangularHeightmap"),c.locUseHeightMap=r.getUniformLocation(c.program,"useHeightMap"),c.locHeightMapIntensity=r.getUniformLocation(c.program,"heightMapIntensity"),r.activeTexture(r.TEXTURE0)),c.supplementalTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,c.supplementalTexture),c.locSupplementalTexture=r.getUniformLocation(c.program,"supplementalTexture"),s){c.iURL=s;let h,f=(h=s.split("."))[h.length-1].toLowerCase();switch(f){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.textureMode="video",n&&(cacheItem=cache.textures.filter(e=>e.url==c.iURL)).length?(console.log("found video in cache... using it"),c.resource=cacheItem[0].resource,c.texture=cacheItem[0].texture):(c.resource=document.createElement("video"),c.resource.muted=!0,c.resource.addEventListener("canplay",()=>{c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed}),c.resource.loop=!0,a.muted||audioConsent||(audioConsent=!0,GenericPopup("play audio OK?",!0,()=>{c.resource.muted=!1,c.resource.currentTime=0,c.resource.play()})),c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed,c.resource.oncanplay=async()=>{c.resource.play()},cache.textures.push({url:s,resource:c.resource,texture:c.texture}),await fetch(s).then(e=>e.blob()).then(e=>{c.resource.src=URL.createObjectURL(e)}));break;default:a.textureMode="image";var u,u=new Image;cache.textures.push({url:s,resource:u,texture:c.texture}),u.onload=async()=>{r.activeTexture(r.TEXTURE0),await BindImage(r,u,c.texture,a.textureMode,-1,s)},await fetch(s).then(e=>e.blob()).then(e=>{u.src=URL.createObjectURL(e)})}}if(r.useProgram(c.program),r.activeTexture(r.TEXTURE0),r.uniform1i(c.locTexture,0),r.bindTexture(r.TEXTURE_2D,c.texture),a.heightMapIsCanvas)c.heightResource=l;else if(l){c.heightMapURL=l;let m,_=(m=l.split("."))[m.length-1].toLowerCase();switch(_){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.heightTextureMode="video",n&&(cacheItem=cache.textures.filter(e=>e.url==c.heightMapURL)).length?(console.log("found video in cache... using it"),c.heightResource=cacheItem[0].resource,c.heightTexture=cacheItem[0].texture):(c.heightResource=document.createElement("video"),c.heightResource.muted=!0,c.heightResource.addEventListener("canplay",()=>{c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed}),c.heightResource.loop=!0,a.muted||audioConsent||(audioConsent=!0,GenericPopup("play audio OK?",!0,()=>{c.heightResource.muted=!1,c.heightResource.currentTime=0,c.heightResource.play()})),c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed,c.heightResource.oncanplay=async()=>{c.heightResource.play()},cache.textures.push({url:l,resource:c.heightResource,texture:c.heightTexture}),await fetch(l).then(e=>e.blob()).then(e=>{c.heightResource.src=URL.createObjectURL(e)}));break;default:a.heightTextureMode="heightImage";var d,d=new Image;c.heightResource=d,cache.textures.push({url:l,resource:d,texture:c.heightTexture}),d.onload=async()=>{r.useProgram(c.program),r.activeTexture(r.TEXTURE4),r.uniform1i(c.locHeightMap,4),await BindImage(r,d,c.heightTexture,a.heightTextureMode,-1,l),r.activeTexture(r.TEXTURE0)},await fetch(l).then(e=>e.blob()).then(e=>{d.src=URL.createObjectURL(e)})}}r.useProgram(c.program),c.locCamPos=r.getUniformLocation(c.program,"camPos"),c.locCamOri=r.getUniformLocation(c.program,"camOri"),c.locGeoPos=r.getUniformLocation(c.program,"geoPos"),c.locGeoOri=r.getUniformLocation(c.program,"geoOri"),c.locFov=r.getUniformLocation(c.program,"fov"),c.locRenderNormals=r.getUniformLocation(c.program,"renderNormals"),r.uniform3f(c.locCamPos,e.x,e.y,e.z),r.uniform3f(c.locCamOri,e.roll,e.pitch,e.yaw),r.uniform3f(c.locGeoPos,e.x,e.y,e.z),r.uniform3f(c.locGeoOri,a.roll,a.pitch,a.yaw),r.uniform1f(c.locFov,e.fov),r.uniform1f(c.locRenderNormals,0)}}else{var g=r.getProgramInfoLog(c.program),v=r.getShaderInfoLog($),y=r.getShaderInfoLog(p);console.error(`bad shader :( ${g}`),console.error(`vShader info : ${v}`),console.error(`fShader info : ${y}`)}}}return i},IsPolyhedron=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":case"dynamic":a=!0;break;default:a=!1}return a},GeometryFromRaw=async(e,a,r,t,o,i,n=!1,c="")=>{var s,l,$,p,h,f,u,m,_,d=new Float32Array,g=new Float32Array,v=e,y=[],x=`${c}_${t}`,b=IsPolyhedron(c);for(m="obj"===c?await subbed(0,1,o,v,a,x):await subbed(t+(b?1:0),1,o,v,a,x),m.map(e=>{e.verts.map(e=>{$=e[0]*=r,p=e[1]*=r,h=e[2]*=r}),n?(d=[...d,e.verts[0],e.verts[1],e.verts[2],e.verts[2],e.verts[3],e.verts[0]],void 0!==e.uvs&&e.uvs.length&&(g=[...g,e.uvs[0],e.uvs[1],e.uvs[2],e.uvs[2],e.uvs[3],e.uvs[0]])):(d=[...d,...e.verts],void 0!==e.uvs&&e.uvs.length&&(g=[...g,...e.uvs]))}),l=0;l<d.length;l++)f=[d[3*(s=l/3|0)+0],d[3*s+1],d[3*s+2]],l%3||(_=Normal(f,b),i||(_[3]=_[0]+(_[0]-_[3]),_[4]=_[1]+(_[1]-_[4]),_[5]=_[2]+(_[2]-_[5]))),y=[...y,{position:d[u=i?d.length-l-1:l],normal:[...d[u],d[u][0]+(_[3]-_[0]),d[u][1]+(_[4]-_[1]),d[u][2]+(_[5]-_[2])],texCoord:g[u]}];return{geometry:y}},subbed=async(e,a,r,t,o,i="")=>{for(var n,c,s,l,$,p,h,f,u,m,_,d,g,v,y,x,b,E,T,P,w,I,A,F,L,M,B,U,k,N,z,O,V,D,H,G,X,Y,q,W,K,j,Z,J,ee,ea,er,et,eo,ei,en,ec,es,el,e$,ep,eh,ef,eu,em,e_,ed,eg,ev,e0,ey,eR,ex,eb,eE,eT,e8,eP,ew,eI,eA,eS,e1,eC,eF,eL,eM,eB,eU=e;eU--;)l=t,$=o,t=new Float32Array,o=new Float32Array,l.map((e,a)=>{switch(m=e[p=0][0],_=e[p][1],d=e[p][2],$.length&&$[a].length>p&&(U=(eC=$[a])[p][0],k=eC[p][1]),g=e[p=1][0],v=e[p][1],y=e[p][2],$.length&&$[a].length>p&&(N=eC[p][0],z=eC[p][1]),x=e[p=2][0],b=e[p][1],E=e[p][2],$.length&&$[a].length>p&&(O=eC[p][0],V=eC[p][1]),e.length>3&&(T=e[p=3][0],P=e[p][1],w=e[p][2],$.length&&$[a].length>p&&(D=eC[p][0],H=eC[p][1]),e.length>4&&(I=e[p=4][0],A=e[p][1],F=e[p][2],$.length&&$[a].length>p&&(G=eC[p][0],X=eC[p][1]),e.length>5&&(L=e[p=5][0],M=e[p][1],B=e[p][2],$.length&&$[a].length>p&&(Y=eC[p][0],q=eC[p][1])))),W=(m+g)/2,K=(_+v)/2,j=(d+y)/2,Z=(g+x)/2,J=(v+b)/2,ee=(y+E)/2,void 0!==U&&(ef=(U+N)/2,eu=(k+z)/2,em=(N+O)/2,e_=(z+V)/2),eI=new Float32Array,eA=new Float32Array,e.length){case 3:ea=(x+m)/2,er=(b+_)/2,et=(E+d)/2,void 0!==U&&(ed=(O+U)/2,eg=(V+k)/2,eA=[...eA,[h=U,f=k]],eA=[...eA,[h=ef,f=eu]],o=[...o,eA=[...eA,[h=ed,f=eg]]],eA=new Float32Array,eA=[...eA,[h=ef,f=eu]],eA=[...eA,[h=N,f=z]],o=[...o,eA=[...eA,[h=em,f=e_]]],eA=new Float32Array,eA=[...eA,[h=ed,f=eg]],eA=[...eA,[h=em,f=e_]],o=[...o,eA=[...eA,[h=O,f=V]]],eA=new Float32Array,eA=[...eA,[h=ef,f=eu]],eA=[...eA,[h=em,f=e_]],o=[...o,eA=[...eA,[h=ed,f=eg]]]),h=m,eI=[...eI,[h,f=_,u=d]],h=W,eI=[...eI,[h,f=K,u=j]],h=ea,t=[...t,eI=[...eI,[h,f=er,u=et]]],eI=new Float32Array,h=W,eI=[...eI,[h,f=K,u=j]],h=g,eI=[...eI,[h,f=v,u=y]],h=Z,t=[...t,eI=[...eI,[h,f=J,u=ee]]],eI=new Float32Array,h=ea,eI=[...eI,[h,f=er,u=et]],h=Z,eI=[...eI,[h,f=J,u=ee]],h=x,t=[...t,eI=[...eI,[h,f=b,u=E]]],eI=new Float32Array,h=W,eI=[...eI,[h,f=K,u=j]],h=Z,eI=[...eI,[h,f=J,u=ee]],h=ea,t=[...t,eI=[...eI,[h,f=er,u=et]]];break;case 4:ea=(x+T)/2,er=(b+P)/2,et=(E+w)/2,eo=(T+m)/2,ei=(P+_)/2,en=(w+d)/2,void 0!==U&&(ed=(O+D)/2,eg=(V+H)/2,ev=(D+U)/2,e0=(H+k)/2,eS=(U+N+O+D)/4,e1=(k+z+V+H)/4,eA=[...eA,[h=U,f=k]],eA=[...eA,[h=ef,f=eu]],eA=[...eA,[h=eS,f=e1]],o=[...o,eA=[...eA,[h=ev,f=e0]]],eA=new Float32Array,eA=[...eA,[h=ef,f=eu]],eA=[...eA,[h=N,f=z]],eA=[...eA,[h=em,f=e_]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=eS,f=e1]],eA=[...eA,[h=em,f=e_]],eA=[...eA,[h=O,f=V]],o=[...o,eA=[...eA,[h=ed,f=eg]]],eA=new Float32Array,eA=[...eA,[h=ev,f=e0]],eA=[...eA,[h=eS,f=e1]],eA=[...eA,[h=ed,f=eg]],o=[...o,eA=[...eA,[h=D,f=H]]]),eE=(m+g+x+T)/4,eT=(_+v+b+P)/4,e8=(d+y+E+w)/4,h=m,eI=[...eI,[h,f=_,u=d]],h=W,eI=[...eI,[h,f=K,u=j]],h=eE,eI=[...eI,[h,f=eT,u=e8]],h=eo,t=[...t,eI=[...eI,[h,f=ei,u=en]]],eI=new Float32Array,h=W,eI=[...eI,[h,f=K,u=j]],h=g,eI=[...eI,[h,f=v,u=y]],h=Z,eI=[...eI,[h,f=J,u=ee]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=eE,eI=[...eI,[h,f=eT,u=e8]],h=Z,eI=[...eI,[h,f=J,u=ee]],h=x,eI=[...eI,[h,f=b,u=E]],h=ea,t=[...t,eI=[...eI,[h,f=er,u=et]]],eI=new Float32Array,h=eo,eI=[...eI,[h,f=ei,u=en]],h=eE,eI=[...eI,[h,f=eT,u=e8]],h=ea,eI=[...eI,[h,f=er,u=et]],h=T,t=[...t,eI=[...eI,[h,f=P,u=w]]];break;case 5:eE=(m+g+x+T+I)/5,eT=(_+v+b+P+A)/5,e8=(d+y+E+w+F)/5,void 0!==U&&(eS=(U+N+O+D+G)/5,e1=(k+z+V+H+X)/5,ed=(O+D)/2,eg=(V+H)/2,ev=(D+G)/2,e0=(H+X)/2,ey=(G+U)/2,eR=(X+k)/2,eA=[...eA,[h=U,f=k]],eA=[...eA,[h=N,f=z]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=N,f=z]],eA=[...eA,[h=O,f=V]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=O,f=V]],eA=[...eA,[h=D,f=H]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=D,f=H]],eA=[...eA,[h=G,f=X]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=G,f=X]],eA=[...eA,[h=U,f=k]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array),ea=(x+T)/2,er=(b+P)/2,et=(E+w)/2,eo=(T+I)/2,ei=(P+A)/2,en=(w+F)/2,ec=(I+m)/2,es=(A+_)/2,el=(F+d)/2,h=m,eI=[...eI,[h,f=_,u=d]],h=g,eI=[...eI,[h,f=v,u=y]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=g,eI=[...eI,[h,f=v,u=y]],h=x,eI=[...eI,[h,f=b,u=E]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=x,eI=[...eI,[h,f=b,u=E]],h=T,eI=[...eI,[h,f=P,u=w]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=T,eI=[...eI,[h,f=P,u=w]],h=I,eI=[...eI,[h,f=A,u=F]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=I,eI=[...eI,[h,f=A,u=F]],h=m,eI=[...eI,[h,f=_,u=d]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array;break;case 6:eE=(m+g+x+T+I)/5,eT=(_+v+b+P+A)/5,e8=(d+y+E+w+F)/5,void 0!==U&&(eS=(U+N+O+D+G+Y)/6,e1=(k+z+V+H+X+q)/6,ed=(O+D)/2,eg=(V+H)/2,ev=(D+G)/2,e0=(H+X)/2,ey=(G+Y)/2,eR=(X+q)/2,ex=(Y+U)/2,eb=(q+k)/2,eA=[...eA,[h=U,f=k]],eA=[...eA,[h=N,f=z]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=N,f=z]],eA=[...eA,[h=O,f=V]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=O,f=V]],eA=[...eA,[h=D,f=H]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=D,f=H]],eA=[...eA,[h=G,f=X]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=G,f=X]],eA=[...eA,[h=Y,f=q]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array,eA=[...eA,[h=Y,f=q]],eA=[...eA,[h=U,f=k]],o=[...o,eA=[...eA,[h=eS,f=e1]]],eA=new Float32Array),ea=(x+T)/2,er=(b+P)/2,et=(E+w)/2,eo=(T+I)/2,ei=(P+A)/2,en=(w+F)/2,ec=(I+L)/2,es=(A+M)/2,el=(F+B)/2,e$=(L+m)/2,ep=(M+_)/2,eh=(B+d)/2,h=m,eI=[...eI,[h,f=_,u=d]],h=g,eI=[...eI,[h,f=v,u=y]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=g,eI=[...eI,[h,f=v,u=y]],h=x,eI=[...eI,[h,f=b,u=E]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=x,eI=[...eI,[h,f=b,u=E]],h=T,eI=[...eI,[h,f=P,u=w]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=T,eI=[...eI,[h,f=P,u=w]],h=I,eI=[...eI,[h,f=A,u=F]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=I,eI=[...eI,[h,f=A,u=F]],h=L,eI=[...eI,[h,f=M,u=B]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array,h=L,eI=[...eI,[h,f=M,u=B]],h=m,eI=[...eI,[h,f=_,u=d]],h=eE,t=[...t,eI=[...eI,[h,f=eT,u=e8]]],eI=new Float32Array}});if(r){eP=r,ew=1-r;for(var eU=2;eU--;)(eU?t:o).map(e=>{e.map(e=>{h=e[0],eL=Math.hypot(h,f=e[1],u=eU?e[2]:0),h/=eL,f/=eL,u/=eL,e[0]=h*=eP+eL*ew,e[1]=f*=eP+eL*ew,eU&&(e[2]=u*=eP+eL*ew)})})}return t.map((e,a)=>({verts:e,uvs:o[a]}))},Camera=(e=0,a=0,r=0,t=0,o=0,i=0)=>({x:e,y:a,z:r,roll:t,pitch:o,yaw:i}),GeoSphere=(e,a,r,t,o)=>{let i,n,c,s,l,$,p,h,f,u=0,m,_,d,g,v,y=Array(t).fill().map(e=>(i=Rn()-.5,n=Rn()-.5,c=Rn()-.5,[i,n,c]));for(let x=50;x--;)y.map((e,a)=>{i=e[0],n=e[1],c=e[2],y.map((e,r)=>{r!=a&&(p=e[0],_=1+(Math.hypot(i-p,n-(h=e[1]),c-(f=e[2]))*(3+t/80)*3)**3,i+=(i-p)*9/_,n+=(n-h)*9/_,c+=(c-f)*9/_)}),_=Math.hypot(i,n,c),e[0]=i/_,e[1]=n/_,e[2]=c/_,u&&(_=25+Math.hypot(i,n,c),e[0]=(i-i/_)/1.1,e[1]=(n-n/_)/1.1,e[2]=(c-c/_)/1.1)});return m=6e6,y.map((e,a)=>{s=e[0],l=e[1],$=e[2],y.map((e,r)=>{p=e[0],h=e[1],f=e[2],a!=r&&(_=Math.hypot(d=s-p,g=l-h,v=$-f))<m&&(m=_)})}),d=new Float32Array,y.map((e,a)=>{s=e[0],l=e[1],$=e[2],y.map((e,r)=>{p=e[0],h=e[1],f=e[2],a!=r&&(_=Math.hypot(s-p,l-h,$-f))<2*m&&!d.filter(e=>e[0]==p&&e[1]==h&&e[2]==f&&e[3]==s&&e[4]==l&&e[5]==$).length&&(d=[...d,[s*o,l*o,$*o,p*o,h*o,f*o]])})}),y.map(t=>{t[0]*=o/1.3333,t[1]*=o/1.3333,t[2]*=o/1.3333,t[0]+=e,t[1]+=a,t[2]+=r}),[e,a,r,o,y,d]},Cylinder=async(e=1,a=0,r,t,o=0,i=!1,n="cylinder")=>{for(var c,s,l,$,p,h,f,u,m,_,d,g,v,y,x,b,E,T,P,w,I,A=new Float32Array,F=new Float32Array,L=0;L<r;L++)for(var M=L-.5,B=0;B<t;B++){c=S(I=2*Math.PI/t*B),s=-.5+1/r*M,l=C(I=2*Math.PI/t*B),$=S(I=2*Math.PI/t*(B+1)),p=-.5+1/r*M,h=C(I=2*Math.PI/t*(B+1)),f=S(I=2*Math.PI/t*(B+1)),u=-.5+1/r*(M+1),m=C(I=2*Math.PI/t*(B+1)),_=S(I=2*Math.PI/t*B),d=-.5+1/r*(M+1),g=C(I=2*Math.PI/t*B);var U=Math.atan2(c,l),k=Math.atan2($,h),N=Math.atan2(f,m),z=Math.atan2(_,g);Math.abs(U-k)>Math.PI&&(U-=2*Math.PI,z-=2*Math.PI),v=(U+Math.PI)/Math.PI/2,y=s+.5,x=(k+Math.PI)/Math.PI/2,b=p+.5,E=(N+Math.PI)/Math.PI/2,T=u+.5,P=(z+Math.PI)/Math.PI/2,w=d+.5,A=[...A,[[c,s,l],[$,p,h],[f,u,m],[_,d,g]]],F=[...F,[[v,y],[x,b],[E,T],[P,w]]]}return await GeometryFromRaw(A,F,e/1.2,a,o,i,!0,n)},Torus=async(e=1,a=0,r=0,t=!1,o="torus",i,n)=>{for(var c,s,l,$,p,h,f,u,m,_,d,g,v,y,x,b,E,T,P,w,I,A,F,L,M,B=new Float32Array,U=new Float32Array,k=4*i,N=.5,z=1.25,O=0;O<k;O++)for(var V=O+.5,D=0;D<n;D++){c=S(L=2*Math.PI/n*D)*N+z,s=C(L)*N,L=Math.atan2(c,l=0)+2*Math.PI/k*V+Math.PI/2,M=Math.hypot(c,l),$=S(L)*M,p=s,h=C(L)*M,c=S(L=2*Math.PI/n*(D+1))*N+z,s=C(L)*N,L=Math.atan2(c,l)+2*Math.PI/k*V+Math.PI/2,M=Math.hypot(c,l),f=S(L)*M,u=s,m=C(L)*M,c=S(L=2*Math.PI/n*(D+1))*N+z,s=C(L)*N,L=Math.atan2(c,l)+2*Math.PI/k*(V+1)+Math.PI/2,M=Math.hypot(c,l),_=S(L)*M,d=s,g=C(L)*M,c=S(L=2*Math.PI/n*D)*N+z,s=C(L)*N,L=Math.atan2(c,l)+2*Math.PI/k*(V+1)+Math.PI/2,M=Math.hypot(c,l),v=S(L)*M,y=s,x=C(L)*M;var H=Math.atan2($,h),G=Math.atan2(f,m),X=Math.atan2(_,g),Y=Math.atan2(v,x);Math.abs(H-X)>Math.PI&&(X+=2*Math.PI,Y+=2*Math.PI),b=(H+Math.PI)/Math.PI/2,E=p+.5,T=(G+Math.PI)/Math.PI/2,P=u+.5,w=(X+Math.PI)/Math.PI/2,I=d+.5,A=(Y+Math.PI)/Math.PI/2,F=y+.5,B=[...B,[[$,p,h],[f,u,m],[_,d,g],[v,y,x]]],U=[...U,[[b,E],[T,P],[w,I],[A,F]]]}return await GeometryFromRaw(B,U,e/1.2,a,r,t,!0,o)},TorusKnot=async(e=1,a=0,r,t,o=0,i=!1,n="torus knot")=>{var c,s,l,$=new Float32Array,p=new Float32Array,h=8*r;t/=1;for(var f,u,m,_,d,g,v,y,x,b,E,T,P,w,I,A,F,L,M,B,U,k,N,z,O,V,D,H,G,X,Y,q,W=.75,K=3,j=1,Z=0;Z<2*h;Z++)for(var J=0;J<t;J++){var ee=Z+.5,ea=Z+1.5,er=Z+2.5;_=K+S(H=3*Math.PI*j/h*ee)/1,d=c=2*C(H),v=K+S(G=3*Math.PI*j/h*ea)/1,y=s=2*C(G),b=K+S(X=3*Math.PI*j/h*er)/1,E=l=2*C(X),Y=(Math.acos((y-d)/(Math.hypot(v-_,y-d)+1e-4))-Math.PI/2)/2,q=(Math.acos((E-y)/(Math.hypot(b-v,E-y)+1e-4))-Math.PI/2)/2;var et=K+S(H)/1;f=S(z=2*Math.PI/t*J)*W+et,z=Math.atan2(u=C(z)*W+c,m=0)+Y,O=Math.hypot(u,m),u=S(z)*O,m=C(z)*O,z=Math.atan2(f,m)+2*Math.PI/h*ee+Math.PI/2,O=Math.hypot(f,m),_=S(z)*O,d=u,g=C(z)*O,f=S(z=2*Math.PI/t*(J+1))*W+et,z=Math.atan2(u=C(z)*W+c,m=0)+Y,O=Math.hypot(u,m),u=S(z)*O,m=C(z)*O,z=Math.atan2(f,m)+2*Math.PI/h*ee+Math.PI/2,O=Math.hypot(f,m),v=S(z)*O,y=u,x=C(z)*O,et=K+S(G)/1,f=S(z=2*Math.PI/t*(J+1))*W+et,z=Math.atan2(u=C(z)*W+s,m=0)+q,O=Math.hypot(u,m),u=S(z)*O,m=C(z)*O,z=Math.atan2(f,m)+2*Math.PI/h*ea+Math.PI/2,O=Math.hypot(f,m),b=S(z)*O,E=u,T=C(z)*O,f=S(z=2*Math.PI/t*J)*W+et,z=Math.atan2(u=C(z)*W+s,m=0)+q,O=Math.hypot(u,m),u=S(z)*O,m=C(z)*O,z=Math.atan2(f,m)+2*Math.PI/h*ea+Math.PI/2,O=Math.hypot(f,m),P=S(z)*O,w=u,I=C(z)*O;var V=Math.atan2(_,g),D=Math.atan2(v,x),eo=Math.atan2(b,T),ei=Math.atan2(P,I);Math.abs(V-eo)>Math.PI&&(eo+=2*Math.PI,ei+=2*Math.PI),A=(V+Math.PI)/Math.PI/2,F=d+.5,L=(D+Math.PI)/Math.PI/2,M=y+.5,B=(eo+Math.PI)/Math.PI/2,U=E+.5,k=(ei+Math.PI)/Math.PI/2,N=w+.5,$=[...$,[[_,d,g],[v,y,x],[b,E,T],[P,w,I]]],p=[...p,[[A,F],[L,M],[B,U],[k,N]]]}return await GeometryFromRaw($,p,e/1.2,a,o,i,!0,n)},Tetrahedron=async(e=1,a=0,r=0,t=!1,o="tetrahedron")=>{var i,n,c,s,l,$,p,h,f,u,m,_,d,g,v,y,x=1,b=new Float32Array,E=new Float32Array;g=new Float32Array;let T=x/1.4142/1.25;for(m=3;m--;)i=S(s=2*Math.PI/3*m)*x/1.25,n=C(s)*x/1.25,g=[...g,[i,n,c=T]];for(_=3,E=[...E,g];_--;)g=new Float32Array,g=[...g,[i=0,n=0,c=-T]],i=S(s=2*Math.PI/3*_)*x/1.25,n=C(s)*x/1.25,g=[...g,[i,n,c=T]],i=S(s=2*Math.PI/3*(_+1))*x/1.25,n=C(s)*x/1.25,E=[...E,g=[...g,[i,n,c=T]]];p=h=f=y=0,E.map(e=>{e.map(e=>{p+=e[0],h+=e[1],f+=e[2],y++})}),p/=y,h/=y,f/=y,E.map(e=>{e.map(e=>{e[0]-=p,e[1]-=h,e[2]-=f})});var P=E,w=new Float32Array;for(m=0;m<P.length;m++){g=new Float32Array;for(var I=P[m].length;I--;){switch(I){case 0:l=0,$=0;break;case 1:l=1,$=0;break;case 2:l=1,$=1;break;case 3:l=0,$=.5;break;case 4:l=0,$=1}g=[...g,[l,$]]}w=[...w,g]}return await GeometryFromRaw(P,w,e,a,r,t,!1,o)},Octahedron=async(e=1,a=0,r=0,t=!1,o="octahedron")=>{var i,n,c,s,l,$,p,h,f,u,m,_,d=1,g=new Float32Array,v=new Float32Array;let y=d/1.25;for(f=8;f--;)m=new Float32Array,m=[...m,[i=0,n=0,c=y*(f<4?-1:1)]],i=S(s=2*Math.PI/4*f)*d/1.25,n=C(s)*d/1.25,m=[...m,[i,n,c=0]],i=S(s=2*Math.PI/4*(f+1))*d/1.25,n=C(s)*d/1.25,v=[...v,m=[...m,[i,n,c=0]]];var x=v,b=new Float32Array;for(h=0;h<x.length;h++){m=new Float32Array;for(var E=x[h].length;E--;){switch(E){case 0:l=0,$=0;break;case 1:l=1,$=0;break;case 2:l=1,$=1;break;case 3:l=0,$=.5;break;case 4:l=0,$=1}m=[...m,[l,$]]}b=[...b,m]}return await GeometryFromRaw(x,b,e,a,r,t,!1,o)},Icosahedron=async(e=1,a=0,r=0,t=!1,o="icosahedron")=>{var i,n,c,s,l,$,p,h,f,u,m,_,d,g,v,y,x,b,E,T,P,w,I,A=new Float32Array,F=new Float32Array;let L=[[[0,3],[1,0],[2,2]],[[0,3],[1,0],[1,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[0,2],[1,3],[1,0]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[1,0],[2,2],[2,1]],[[1,1],[2,2],[2,1]],[[1,1],[2,2],[0,0]],[[1,1],[2,1],[0,1]],[[0,2],[2,1],[0,1]],[[2,0],[1,2],[2,3]],[[0,0],[0,3],[2,3]],[[1,3],[2,0],[2,3]],[[2,3],[0,0],[1,2]],[[1,2],[2,0],[0,1]],[[0,0],[1,2],[1,1]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]],];for(d=3,y=[[-(v=.5+2.23606797749979/2),-1,0],[v,-1,0],[v,1,0],[-v,1,0],];d--;F=[...F,$])for($=[],i=4;i--;)$=[...$,[y[i][d],y[i][(d+1)%3],y[i][(d+2)%3]]];F.map(e=>{e.map(e=>{e[0]*=1/2.25,e[1]*=1/2.25,e[2]*=1/2.25})}),x=JSON.parse(JSON.stringify(F)),m=[],y=new Float32Array,L.map(e=>{b=e[0][0],E=e[1][0],T=e[2][0],P=e[0][1],w=e[1][1],I=e[2][1],y=[...y,[x[b][P],x[E][w],x[T][I]]]});var M=m=[...m,...y],B=new Float32Array;for(i=0;i<M.length;i++){y=new Float32Array;for(var U=M[i].length;U--;){switch(U){case 0:f=0,u=0;break;case 1:f=1,u=0;break;case 2:f=1,u=1;break;case 3:f=0,u=.5;break;case 4:f=0,u=1}y=[...y,[f,u]]}B=[...B,y]}return await GeometryFromRaw(M,B,e,a,r,t,!1,o)},Dodecahedron=async(e=1,a=0,r=0,t=!1,o="dodecahedron")=>{var i,n,c,s,l,$,p,h,f,u,m,_,d,g=new Float32Array,v=new Float32Array;let y=-6e6;for(i=5;i--;)n=S(p=2*Math.PI/5*i+Math.PI/5),c=C(p),s=0,c>y&&(y=c),v=[...v,[n,c,s]];v=v.map(e=>(n=e[0],R(n,c=e[1]-=y,s=e[2],{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0}))),($=structuredClone(v)).map(e=>{e[1]*=-1}),g=[...g,v,$],y=-6e6,g.map(e=>{e.map(e=>{n=e[0],c=e[1],(s=e[2])>y&&(y=s)})}),l=Math.hypot(g[0][0][0]-g[0][1][0],g[0][0][1]-g[0][1][1],g[0][0][2]-g[0][1][2]),g.map(e=>{e.map(e=>{e[2]-=y+l/2})}),($=structuredClone(g)).map(e=>{e.map(e=>{e[2]*=-1})}),g=[...g,...$],($=structuredClone(g)).map(e=>{e.map(e=>{n=e[0],h=R_ypr(n,c=e[1],s=e[2],{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:Math.PI/2}),e[0]=h[0],e[1]=h[1],e[2]=h[2]})}),(x=structuredClone(g)).map(e=>{e.map(e=>{n=e[0],h=R_ypr(n,c=e[1],s=e[2],{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:Math.PI/2}),e[0]=h[0],e[1]=h[1],e[2]=h[2]})});var x=g=[...g,...$,...x],b=new Float32Array;for(i=0;i<x.length;i++){v=new Float32Array;for(var E=x[i].length;E--;){switch(E){case 0:f=0,u=0;break;case 1:f=1,u=0;break;case 2:f=1,u=1;break;case 3:f=0,u=.5;break;case 4:f=0,u=1}v=[...v,[f,u]]}b=[...b,v]}return await GeometryFromRaw(x,b,e/Math.max(1,2-r),a,r,t,!1,o)},Cube=async(e=1,a=0,r=0,t=!1,o="cube")=>{var i,n,c,s,l,$,p,h,f,u,m,_,d,g,v,y=Math.PI,x=new Float32Array,b=new Float32Array;for(l=6;l--;b=[...b,c])for(c=[],$=4;$--;)c=[...c,[(n=[S(i=2*y/4*$+y/4),C(i),1.4142135623730951/2])[l%3]*(s=l<3?1:-1),n[(l+1)%3]*s,n[(l+2)%3]*s]];var E=new Float32Array;for(l=0;l<b.length;l++){n=new Float32Array;for(var p=b[l].length;p--;){switch(p){case 0:h=0,f=0;break;case 1:h=1,f=0;break;case 2:h=1,f=1;break;case 3:h=0,f=1}n=[...n,[h,f]]}E=[...E,n]}return await GeometryFromRaw(b,E,e/1.2,a,r,t,!0,o)},Rectangle=async(e=1,a=0,r=0,t=!1,o="rectangle")=>{var i,n,c,s,l,$,p,h,f,u,m,_,d,g,v,y,x=Math.PI,b=new Float32Array,E=new Float32Array;return await GeometryFromRaw(E=[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],]],[[[0,0],[1,0],[1,1],[0,1],]],e/1.5,Math.max("sprite"==o?1:2,a),"sprite"==o?.1:r,t,!0,o)},IsPowerOf2=(e,a=0)=>!(a>300)&&(2==e||IsPowerOf2(e/2,a+1)),PointInPoly3D=(e,a,r,t,o,i,n,c=!1)=>{let s,l,$,p,h,f,u,m,_,d=(e,a,r,t,o,i,n,c)=>(f=((n-o)*(a-i)-(c-i)*(e-o))/(u=(c-i)*(r-e)-(n-o)*(t-a)))>=0&&f<=1&&(m=((r-e)*(a-i)-(t-a)*(e-o))/u)>=0&&m<=1?[e+f*(r-e),a+f*(t-a)]:0,g=(e,a,r,t)=>{let o=Math,i=o.atan2,n=o.hypot;s=S(_=i(s,l)+e)*(p=n(s,l)),l=C(_)*p,s=S(_=i(s,$)+r)*(p=n(s,$)),$=C(_)*p,l=S(_=i(l,$)+a)*(p=n(l,$)),$=C(_)*p,t&&(s+=oX,l+=oY,$+=oZ)},v=e=>{switch(e){case 0:g(0,0,Math.PI/2);break;case 1:g(0,Math.PI/2,0);break;case 2:g(Math.PI/2,0,Math.PI/2)}},y=0,x=0,b=0;n.map(e=>{y+=e[0],x+=e[1],b+=e[2]}),y/=n.length,x/=n.length,b/=n.length;let E=n[2][0]-n[1][0],T=n[2][1]-n[1][1],P=n[2][2]-n[1][2],w=n[1][0]-n[0][0],I=n[1][1]-n[0][1],A=n[1][2]-n[0][2],F=[T*A-P*I,P*w-E*A,E*I-T*w];p=Math.hypot(...F)+.001;let L=1;F=F.map(e=>e/p*L);let M=y,B=x,U=b,k=1;if(c){let N=Math.hypot(M-e,B-a,U-r);k=Math.hypot(e-(y+F[0]/99),a-(x+F[1]/99),r-(b+F[2]/99))>N?-1:1}let z=y+(F[0]*=k),O=x+(F[1]*=k),V=b+(F[2]*=k),D=Math.atan2(z-M,V-U),H=-(Math.acos((O-B)/(Math.hypot(z-M,O-B,V-U)+.001))+Math.PI/2),G=!1,X=[!1,!1,!1];s=e,l=a,$=r,g(0,-H,-D);let Y=s,q=l,W=$;for(let K=3;K--;)!1===G&&(s=Y,l=q,$=W,v(K),M=s,B=l,U=$=5,s=t,l=o,$=i,g(0,-H,-D),v(K),z=s,O=l,V=$,n.map((e,a)=>{if(!1===G){let r=a;s=n[r][0],l=n[r][1],$=n[r][2],g(0,-H,-D),v(K);let t=s,o=l;s=n[r=(a+1)%n.length][0],l=n[r][1],$=n[r][2],g(0,-H,-D),v(K);let i=s,c=l;(h=d(M,B,z,O,t,o,i,c))&&(X[K]=h)}}));if(3==X.filter(e=>!1!==e).length){let j=X[1][0],Z=X[0][1],J=X[0][0],ee=!0;y=0,x=0,b=0,n.map((e,a)=>{y+=e[0],x+=e[1],b+=e[2]}),y/=n.length,x/=n.length,b/=n.length,s=y,l=x,$=b,g(0,-H,-D),M=s,B=l,U=$,z=j,O=Z,V=J,n.map((e,a)=>{if(ee){let r=a;s=n[r][0],l=n[r][1],$=n[r][2],g(0,-H,-D);let t=s,o=l;s=n[r=(a+1)%n.length][0],l=n[r][1],$=n[r][2],g(0,-H,-D);let i=s,c=l;d(M,B,z,O,t,o,i,c)&&(ee=!1)}}),ee&&(s=j,l=Z,$=J,g(0,H,0),g(0,0,D),G=[[s,l,$],[F[0],F[1],F[2]]])}return G},Reflect=(e,a)=>{let r=Math.hypot(...e)+1e-5,t=Math.hypot(...a)+1e-5;e[0]/=r,e[1]/=r,e[2]/=r,a[0]/=t,a[1]/=t,a[2]/=t;let o=-e[0]*a[0]+-e[1]*a[1]+-e[2]*a[2],i=-e[0]-2*a[0]*o,n;return[-i*r,-(-e[1]-2*a[1]*o)*r,-(-e[2]-2*a[2]*o)*r]},PointInPoly2D=(e,a,r)=>{var t,o,i,n,c,s,l,$,p,h=0,f=0,u=0;return r.map(e=>{h+=e[0],f+=e[1],u++}),h/=u,f/=u,t=e,o=a,i=1e6,n=1e6,u=0,r.map((e,a)=>{c=r[p=a][0],s=r[p][1],Intersects(t,o,i,n,c,s,l=r[p=(a+1)%r.length][0],$=r[p][1])&&u++}),1==u},Intersects=(e,a,r,t,o,i,n,c)=>{var s,l,$;return(s=((n-o)*(a-i)-(c-i)*(e-o))/(l=(c-i)*(r-e)-(n-o)*(t-a)))>=0&&s<=1&&($=((r-e)*(a-i)-(t-a)*(e-o))/l)>=0&&$<=1&&[e+s*(r-e),a+s*(t-a)]},Normal=(e,a=!1,r=0,t=0,o=0)=>{var i,n,c=0,s=0,l=0;e.map(e=>{c+=e[0],s+=e[1],l+=e[2]}),c/=e.length,s/=e.length,l/=e.length;var $=e[2][0]-e[1][0],p=e[2][1]-e[1][1],h=e[2][2]-e[1][2],f=e[1][0]-e[0][0],u=e[1][1]-e[0][1],m=e[1][2]-e[0][2];n=Math.hypot(...i=[p*m-h*u,h*f-$*m,$*u-p*f])+1e-4;var _=1;i=i.map(e=>e/n*_);var d=c,g=s,v=l,y=1;if(a){var x,b=Math.hypot(d-r,g-t,v-o);y=Math.hypot(r-(c+i[0]/99),t-(s+i[1]/99),o-(l+i[2]/99))>b?-1:1}var E=c+(i[0]*=y),T=s+(i[1]*=y),P=l+(i[2]*=y);return[d,g,v,E,T,P]},UnloadFPSControls=async e=>{e.cameraMode="default",e.showCrosshair=!1,e.useFPSControls=!1},LoadFPSControls=async(e,a)=>{var r=1,t=1,o=.01;e.cameraMode="fps",e.crosshairMap="",e.showCrosshair=!0,e.lastInteraction=0,e.hasTraction=!0,e.focusRequiredForMouse=!0,e.useKeys=!0,e.crosshairSel=0,e.useFPSControls=!0;var i=[,,,].fill().map((e,a)=>`${ModuleBase}/resources/crosshairs/crosshair${a+1}.png`);void 0!==a&&Object.keys(a).forEach((i,n)=>{switch(i.toLowerCase()){case"mspeed":r=a[i];break;case"rspeed":t=a[i];break;case"grav":o=a[i];break;case"crosshairsel":e.crosshairSel=a[i];break;case"usekeys":e.useKeys=!!a[i];break;case"crosshairmap":e.crosshairMap=a[i];break;case"showcrosshair":e.showCrosshair=!!a[i];break;case"focusrequiredformouse":e.focusRequiredForMouse=!!a[i]}});var n=!1,c=Array(i.length).fill();if(c.map(async(e,a)=>{c[a]={img:new Image,loaded:!1},c[a].img.onload=()=>{c[a].loaded=!0},await fetch(i[a]).then(e=>e.blob()).then(e=>{c[a].img.src=URL.createObjectURL(e)})}),e.crosshairMap&&(e.crosshairSel=i.length,c.push({img:new Image,loaded:!1}),c[c.length-1].img.onload=()=>{c[c.length-1].loaded=!0},await fetch(e.crosshairMap).then(e=>e.blob()).then(e=>{c[c.length-1].img.src=URL.createObjectURL(e)})),e.useKeys){var s,l,$=.1*r,p=.005*t,h=0,f=0,u=0,m=0,_=0,d=0,g=0,v=0,y=1,x=1.66,b=1.2,E=!1;e.keys=Array(256).fill().map((e,a)=>!1),e.keyTimers=Array(256).fill(0),e.keyTimerInterval=.2,window.addEventListener("keydown",a=>{e.keys[a.keyCode]=!0,e.lastInteraction=e.t}),window.addEventListener("keyup",a=>{e.keys[a.keyCode]=!1,e.lastInteraction=e.t}),window.addEventListener("mousedown",a=>{if(e.lastInteraction=e.t,0===a.button){var r;E=!0,document.querySelectorAll(".genericPopup").length||e.c.requestPointerLock({unadjustedMovement:!0})}}),window.addEventListener("mouseup",a=>{e.lastInteraction=e.t,0===a.button&&(E=!1)}),window.addEventListener("mousemove",a=>{if(e.lastInteraction=e.t,document.pointerLockElement==e.c||!e.focusRequiredForMouse){var r=e.c.getBoundingClientRect();s=(a.pageX-r.left)/e.c.clientWidth*e.c.width,l=(a.pageY-r.top)/e.c.clientHeight*e.c.height,h-=a.movementX*p,f+=a.movementY*p}}),e.doKeys=async()=>{if(e.showCrosshair&&c[e.crosshairSel].loaded){var a=200;overlay.ctx.globalAlpha=.6,overlay.ctx.drawImage(c[e.crosshairSel].img,overlay.width/2-a/2,overlay.height/2-a/2,a,a),overlay.ctx.globalAlpha=1}e.yaw+=h,e.pitch+=f,e.pitch=Math.min(Math.PI/2,Math.max(-Math.PI/2,e.pitch)),h/=x,f/=x,e.x+=d,e.y+=g,e.z+=v,e.hasTraction&&(d/=b,g/=b,v/=b),y=1,e.hasTraction&&e.keys.map((a,r)=>{if(e.keys[r])switch(r){case 16:y=3;break;case 37:h+=12*p;break;case 38:f-=12*p;break;case 39:h-=12*p;break;case 40:f+=12*p;break;case 87:var t=-e.yaw+Math.PI,o=e.pitch;d+=S(t)*$*y,v+=C(t)*$*y;break;case 65:var t=-e.yaw+Math.PI/2,o=e.pitch;d+=S(t)*$*y,v+=C(t)*$*y;break;case 83:var t=-e.yaw+Math.PI,o=e.pitch;d-=S(t)*$*y,v-=C(t)*$*y;break;case 68:var t=-e.yaw+Math.PI/2,o=e.pitch;d+=-S(t)*$*y,v+=-C(t)*$*y}})}}},AnimationLoop=(e,a)=>{let r=async()=>{if(overlay.margin=e.margin,overlay.rsz(),overlay.width=e.width,overlay.height=e.height,overlay.c.width=e.c.width,overlay.c.height=e.c.height,e.ready&&void 0!==window[a]&&await window[a](),e.particleQueue.length){var t,o=new Float32Array;e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e.particleQueue.map((a,r)=>{var i,n,c,s=a.x+e.x;t=R(s,a.y+e.y,a.z+e.z,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),o=[...o,{idx:r,z:e.z/1e3*Math.pow(5,Math.log(e.fov)/1.609438)+t[2]}]}),o.sort((e,a)=>a.z-e.z),e.particleQueue.map(async(a,r)=>{var t=e.particleQueue[o[r].idx],i=()=>!1;i()&&e.ctx.disable(e.ctx.DEPTH_TEST);for(var n=t.penumbra,c=1+(t.isParticle&&n?1:0);c--;)await e.Draw(t,!0,t.isParticle&&n&&!c);i()&&e.ctx.enable(e.ctx.DEPTH_TEST)}),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}if(e.alphaQueue.length){var t,o=new Float32Array;e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e.alphaQueue.map((a,r)=>{var i,n,c,s=a.x+e.x;t=R(s,a.y+e.y,a.z+e.z,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),o=[...o,{idx:r,z:e.z/1e3*Math.pow(5,Math.log(e.fov)/1.609438)+t[2]}]}),o.sort((e,a)=>a.z-e.z),e.alphaQueue.map(async(a,r)=>{var t=e.alphaQueue[o[r].idx],i=()=>!1;i()&&e.ctx.disable(e.ctx.DEPTH_TEST);for(var n=t.penumbra,c=1+(t.isParticle&&n?1:0);c--;)await e.Draw(t,!0,t.isParticle&&n&&!c);i()&&e.ctx.enable(e.ctx.DEPTH_TEST)}),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e.t+=1/60,requestAnimationFrame(r),e.alphaQueue=new Float32Array,e.particleQueue=new Float32Array,e.useKeys&&await e.doKeys()};window.addEventListener("load",()=>{e.ready=!0,r()})},RGBToHSV=(e,a,r)=>HSVFromRGB(e,a,r),HSVFromRGB=(e,a,r)=>{let t=e/255,o=a/255,i=r/255,n=Math.min(t,o,i),c=Math.max(t,o,i),s=c,l=c-n,$=c?l/c:0,p=Math.min(e,a,r),h=Math.max(e,a,r),f=0;for(l&&(e>=a&&e>=r&&(f=(a-r)/(h-p)),a>=e&&a>=r&&(f=2+(r-e)/(h-p)),r>=a&&r>=e&&(f=4+(e-a)/(h-p))),f*=60;f<0;)f+=360;for(;f>=360;)f-=360;return[f,$,s]},HSVToHex=(e,a,r)=>HexFromHSV(e,a,r),HexFromHSV=(e,a,r)=>{let t=RGBFromHSV(e,a,r);return RGBToHex(...t)},HSVToRGB=(e,a,r)=>RGBFromHSV(e,a,r),RGBFromHSV=(e,a,r)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let t=r*a,o=t*(1-Math.abs(e/60%2-1)),i=r-t,n,c,s;e>=0&&e<60&&(n=t,c=o,s=0),e>=60&&e<120&&(n=o,c=t,s=0),e>=120&&e<180&&(n=0,c=t,s=o),e>=180&&e<240&&(n=0,c=o,s=t),e>=240&&e<300&&(n=o,c=0,s=t),e>=300&&e<360&&(n=t,c=0,s=o);let l=(n+i)*255,$;return[l,(c+i)*255,(s+i)*255]},HexFromRGB=(e,a,r)=>RGBToHex(e,a,r),RGBToHex=(e,a,r)=>{let t="0123456789abcdef",o="";return o+=t[e/16|0],o+=t[e-(e/16|0)*16|0],o+=t[a/16|0],o+=t[a-(a/16|0)*16|0],o+=t[r/16|0],Number("0x"+(o+=t[r-(r/16|0)*16|0]))},RGBFromHex=e=>HexToRGB(e),HexToRGB=e=>{var a,r=e/256-(e/256|0),t=e/65536-(e/65536|0);return[e/16777216-(e/16777216|0),t,r]},getParams=e=>{var a,r=[];["COPY_READ_BUFFER_BINDING","COPY_WRITE_BUFFER_BINDING","DRAW_BUFFERi","DRAW_FRAMEBUFFER_BINDING","FRAGMENT_SHADER_DERIVATIVE_HINT","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET","PACK_ROW_LENGTH","PACK_SKIP_PIXELS","PACK_SKIP_ROWS","PIXEL_PACK_BUFFER_BINDING","PIXEL_UNPACK_BUFFER_BINDING","RASTERIZER_DISCARD","READ_BUFFER","READ_FRAMEBUFFER_BINDING","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_COVERAGE","SAMPLER_BINDING","TEXTURE_BINDING_2D_ARRAY","TEXTURE_BINDING_3D","TRANSFORM_FEEDBACK_ACTIVE","TRANSFORM_FEEDBACK_BINDING","TRANSFORM_FEEDBACK_BUFFER_BINDING","TRANSFORM_FEEDBACK_PAUSED","UNIFORM_BUFFER_BINDING","UNIFORM_BUFFER_OFFSET_ALIGNMENT","UNPACK_IMAGE_HEIGHT","UNPACK_ROW_LENGTH","UNPACK_SKIP_IMAGES","UNPACK_SKIP_PIXELS","UNPACK_SKIP_ROWS","VERTEX_ARRAY_BINDING"].map(a=>{r.push({name:a,val:e.getParameter(e[a])})});var t=document.createElement("div");t.style.position="fixed",t.style.zIndex=1e5,t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.background="#0008",t.style.padding="20px",t.style.width="600px",t.style.height="350px",t.style.border="1px solid #fff4",t.style.borderRadius="5px",t.style.fontFamily="monospace",t.style.fontSize="20px",t.style.color="#fff";var o=document.createElement("div");o.style.fontSize="24px",o.style.color="#0f8c",o.innerHTML="rendering context parameters<br><br>",t.appendChild(o);var i=document.createElement("div");i.style.minWidth="100%",i.style.height="250px",i.style.background="#333",i.style.border="1px solid #fff4",i.style.overflowY="auto",i.style.wordWrap="break-word",i.style.color="#888",i.style.fontSize="10px",t.appendChild(i);var n=document.createElement("button");n.style.border="none",n.style.padding="3px",n.style.cursor="pointer",n.fontSize="20px",n.style.borderRadius="10px",n.style.margin="10px",n.style.minWidth="100px",n.innerHTML="\uD83D\uDCCB copy",n.title="copy shape data to clipboard",n.onclick=()=>{var e=document.createRange();e.selectNode(i),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),n.innerHTML="COPIED!",setTimeout(()=>{n.innerHTML="\uD83D\uDCCB copy"},1e3)},t.appendChild(n);var c=document.createElement("button");c.onclick=()=>t.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",t.appendChild(c),i.innerHTML=JSON.stringify(r),document.body.appendChild(t)};(overlay=await Renderer({context:{mode:"2d",margin:0}})).c.style.background="#0000",overlay.c.style.zIndex=1e4;var scratchHeightMap=document.createElement("canvas"),SHMctx=scratchHeightMap.getContext("2d",{willReadFrequently:!0});export{Renderer,LoadGeometry,BasicShader,DestroyRenderer,ResizeRenderer,DestroyShape,AnimationLoop,Tetrahedron,Cube,Octahedron,Icosahedron,Dodecahedron,Cylinder,Torus,TorusKnot,Rectangle,Q,R,SyncNormals,Intersects,PointInPoly2D,PointInPoly3D,ShowBounding,Reflect,Normal,ImageToPo2,LoadOBJ,IsPowerOf2,RGBToHSV,HSVToHex,HexFromHSV,HSVToRGB,RGBFromHSV,HexFromRGB,RGBToHex,RGBFromHex,HexToRGB,GeoSphere,ModuleBase,LoadFPSControls};